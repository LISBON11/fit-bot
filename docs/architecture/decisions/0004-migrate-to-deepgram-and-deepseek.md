# 4. Миграция с OpenAI на Deepgram и DeepSeek

Дата: 2026-02-24

## Статус

Принято

## Контекст

Первоначальная архитектура предполагала использование сервисов OpenAI:

1. **Whisper API** для Speech-to-Text (STT) преобразования голосовых сообщений.
2. **GPT-4o-mini** для Natural Language Understanding (NLU) - извлечения структурированных данных тренировки из текста.

В процессе разработки и подготовки к production-развертыванию были выявлены следующие проблемы с текущим стеком:

- **STT (Whisper)**: Telegram присылает голосовые сообщения в формате OGG Opus. Whisper API не поддерживает этот формат напрямую, что требовало использования `ffmpeg` для конвертации аудио "на лету" (в памяти). Это усложняет инфраструктуру (требование `ffmpeg` в Docker-контейнере) и увеличивает latency.
- **NLU (GPT)**: Доступность сервисов OpenAI может быть ограничена в зависимости от региона сервера (особенно при развертывании в РФ или использовании серверов с заблокированными IP), а также стоимость токенов GPT может быть неоптимальной на долгосрочной перспективе.

## Решение

Мы приняли решение полностью отказаться от использования OpenAI в пользу более специализированных и доступных альтернатив:

1. **Замена STT на Deepgram Nova-3 API:**
   - Deepgram нативно поддерживает формат OGG Opus, что полностью избавляет от необходимости использовать `ffmpeg` для локальной конвертации аудиофайлов.
   - Уменьшается потребление памяти и ускоряется обработка голосовых сообщений (поток байт из Telegram уходит напрямую в Deepgram).
2. **Замена NLU на DeepSeek V3 (deepseek-chat):**
   - DeepSeek V3 отлично справляется с русским языком.
   - Поддерживает JSON mode (structured output), что необходимо для нашего `WorkoutParser` и совместимо с текущей Zod-схемой (`ParsedWorkoutSchema`).
   - Более низкая стоимость токенов по сравнению с GPT-4o-mini.
   - API совместимо с OpenAI SDK, либо легко интегрируется напрямую, и работает без ограничений блокировок IP адресов РФ.

## Последствия

### Положительные

- Избавление от зависимости `ffmpeg` в production-образе (уменьшение размера Docker-образа и устранение потенциальных уязвимостей/проблем с памятью).
- Уменьшение latency при распознавании голоса за счет отсутствия шага конвертации аудио.
- Снижение операционных расходов (дешевле токены NLU).
- Повышение доступности и устойчивости сервиса (DeepSeek доступен без региональных блокировок).

### Отрицательные (Риски)

- Зависимость от новых вендоров (Deepgram и DeepSeek) и необходимость мониторинга их аптайма и качества работы.
- Необходимость переписывать\дорабатывать моки в тестах, ориентируясь на новых провайдеров.

## Изменения в коде

- Удалены переменные `OPENAI_API_KEY`. Взамен добавлены `DEEPGRAM_API_KEY` и `DEEPSEEK_API_KEY`.
- Добавлен пакет `@deepgram/sdk`, удалены пакеты `openai`, `fluent-ffmpeg`, `@types/fluent-ffmpeg`.
- Модуль STT переписан на класс `DeepgramStt` (`src/stt/deepgram.stt.ts`). Транскрипция происходит напрямую без `temp`-файлов и конвертаций.
- Модуль NLU обновлен для использования DeepSeek V3 (JSON mode).
- Обновлены тесты STT, NLU: переписаны моки для Deepgram, в NLU обновлены fixtures.
- Обновлена документация (`SYSTEM_DESIGN.md`, `DEPLOYMENT.md`, `README.md`, `ROADMAP.md`).
