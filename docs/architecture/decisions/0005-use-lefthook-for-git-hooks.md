# 5. Использование Lefthook для Git Hooks

Дата: 2026-02-24

## Статус

Принято

## Контекст

Для обеспечения качества кода необходимо автоматизировать запуск проверок (линтер, форматтер, проверка типов, тесты) перед коммитом и пушем. Исторически популярным инструментом для этого в экосистеме Node.js является `husky` в связке с `lint-staged`.

Однако в ходе анализа инструментов были выявлены следующие проблемы стандартного подхода:

- Относительно медленное выполнение проверок `lint-staged`.
- Сложность настройки параллельного выполнения нескольких ресурсоемких задач (например, `eslint` и `prettier` параллельно).
- Перегруженность `package.json` конфигурациями (если не выносить в отдельные файлы).

## Решение

Мы приняли решение использовать **Lefthook** вместо `husky` и `lint-staged` для управления Git-хуками.

## Обоснование

1. **Производительность:** Lefthook написан на Go и выполняет команды параллельно (с поддержкой настройки concurrency), что значительно ускоряет выполнение `pre-commit` хуков.
2. **Единый конфигурационный файл:** Вся конфигурация хуков хранится в одном понятном `lefthook.yml` файле.
3. **Удобство работы с файлами:** Встроенная поддержка фильтрации staged файлов (`{staged_files}`).
4. **Гибкость:** Позволяет легко задавать разные группы проверок на `pre-commit` (линтер, форматтер, typecheck, быстрые тесты) и `pre-push` (полный набор e2e тестов, сборка).

## Последствия

### Положительные

- Мгновенная обратная связь для разработчика благодаря быстрому параллельному выполнению проверок перед коммитом.
- Более простая и прозрачная конфигурация в `lefthook.yml`.
- Отсутствие необходимости поддерживать `lint-staged`.

### Отрицательные

- Необходимость изучения нового инструмента (хотя его синтаксис интуитивно понятен).
- Исполняемый файл Lefthook (написан на Go) устанавливается как бинарник, что добавляет небольшую зависимость системного уровня (хотя NPM-обертка решает эту проблему для большинства платформ).

## Изменения в коде

- Удалены (или не были добавлены) зависимости: `husky`, `lint-staged`.
- Установлен пакет `lefthook` как devDependency.
- Создан конфигурационный файл `lefthook.yml` с настройками `pre-commit` хука для запуска `eslint`, `prettier` (на staged файлах) и `tsc` с `jest` (на всем проекте/измененных модулях).
- В `package.json` добавлен скрипт `postinstall: "lefthook install"` для автоматического развертывания хуков у всех разработчиков после `npm ci`.
