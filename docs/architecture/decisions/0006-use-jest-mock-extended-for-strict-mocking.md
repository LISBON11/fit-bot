# 6. Использование jest-mock-extended для строго типизированных моков

Дата: 2026-02-24

## Статус

Принято

## Контекст

В процессе написания интеграционных и unit-тестов для сервисов и слоя работы с БД (Prisma) возникла потребность в создании сложных мок-объектов.
Изначальный подход заключался в использовании `as unknown as jest.Mocked<Type>`, `as any` или подавления ошибок TypeScript через `@ts-expect-error`.

**Проблемы предыдущего подхода:**

- Потеря строгой типизации при рефакторинге (TypeScript пропускал невалидные поля объекта мока).
- Громоздкий boilerplate код создания моков (приходилось подменять `PrismaClient` и частично реализовывать его методы вручную, например `.findUnique`, `.create`).
- Использование "костыльных" моков: они не всегда полностью совпадали по структуре с объектом, который они заменяют.
- Частые ошибки компилятора и линтера в тестовых файлах, маскируемые `eslint-disable`.

## Решение

Мы приняли решение отказаться от использования нестрогих приведений типов (`as any` и др.) и перейти на библиотеку `jest-mock-extended`. Она позволяет:

- Автоматически создавать глубокие (deep) моки сложных интерфейсов и классов, сохраняя их сигнатуры.
- Выносить логику моков общих зависимостей (например, `createMockCtx` для Telegram-контекста, моки репозиториев) в шареные scope или `__tests__` папки.

## Обоснование

1. **Строгая безопасность типов (Type safety):** `mockDeep<T>()` гарантирует, что мок содержит все необходимые методы `T`, а компилятор TS корректно проверяет параметры вызова `mockResolvedValue` и других jest-методов.
2. **Чистота тестов:** Уменьшается дублирование кода - вместо повторного написания фальшивых объектов в каждом тесте мы импортируем фабричные моки. Это делает тесты более читаемыми.
3. **Соответствие правилу пользователя:** Полный запрет на использование "костыльных" моков с использованием `@typescript-eslint/no-explicit-any`, `ts-expect-error` или `eslint-disable`. Мок всегда должен строго соответствовать объекту.

## Последствия

### Положительные

- Нулевое количество ошибок типа и linting errors в папках `__tests__`.
- Повышение надежности тестов - если меняется интерфейс сервиса, тесты сломаются еще на этапе компиляции, а не в рантайме.
- Централизованный менеджмент моков (DRY) для сервисов и репозиториев.

### Отрицательные

- Небольшая кривая обучения библиотеки `jest-mock-extended` для новых разработчиков.

## Изменения в коде

- Установлена библиотека `jest-mock-extended` как dev dependency.
- В тестах удалены все `as any`, `@ts-expect-error` и нестрогие `jest.Mocked`.
- Имплементированы общие фабрики для создания MockContext для Telegram (`createMockCtx`).
- Обновлены тесты Prisma-репозиториев (используется строгий `mockDeep<PrismaClient>()`).
