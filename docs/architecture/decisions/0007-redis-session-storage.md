# ADR-0007: Redis как хранилище сессий grammY

## Статус

Принято — 2026-02-24

## Контекст

Telegram-бот использует плагин `@grammyjs/conversations` для управления многошаговыми диалогами
(новая тренировка, редактирование, уточнение упражнений). Плагин сохраняет состояние диалога
через механизм сессий grammY.

По умолчанию grammY хранит сессии **в памяти процесса** (`MemorySessionStorage`). Это означает:

- При перезапуске бота (деплой, crash) все активные диалоги теряются
- Пользователь, нажавший «✏️ Edit» до перезапуска, не сможет завершить диалог

Рассматривались альтернативы:

| Вариант               | Плюсы                                  | Минусы                                                 |
| --------------------- | -------------------------------------- | ------------------------------------------------------ |
| In-memory (было)      | Нет зависимостей                       | Теряется при перезапуске                               |
| Object Storage (файл) | Персистентно                           | ~200ms на R/W, нет атомарных операций → race condition |
| Redis                 | Персистентно, ~1ms, атомарные операции | Требует Redis-инстанс                                  |

Redis уже присутствует в инфраструктуре проекта (используется для `processingLock`),
поэтому добавление хранилища сессий не требует новых зависимостей.

## Решение

Использовать `@grammyjs/storage-redis` (`RedisAdapter`) для хранения grammY-сессий в Redis.

```typescript
const storage = new RedisAdapter<SessionData>({
  instance: getRedisClient(), // существующий singleton
  ttl: 86400, // автоочистка через 24 часа
});

bot.use(session({ initial: () => ({}), storage }));
```

**TTL 24 часа** — сессия автоматически удаляется если пользователь не активен сутки.
Это предотвращает накопление устаревших данных в Redis.

## Последствия

- Сессии переживают перезапуск бота (деплой, crash)
- Race condition при параллельных update'ах одного пользователя исключён
- Добавлена зависимость `@grammyjs/storage-redis`
- Данные в памяти Redis: ключи `session:{chatId}` + `processing_lock:{userId}`
