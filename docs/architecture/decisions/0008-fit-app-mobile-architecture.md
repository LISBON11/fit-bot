# ADR-0008: Архитектура мобильного приложения FitApp

- **Статус**: Предложено
- **Дата**: 2026-02-24
- **Связанные ADR**: ADR-0003 (Supabase), ADR-0004 (Deepgram + DeepSeek)

## Контекст

Telegram-бот FitBot достиг стадии MVP и работает в продакшене. Следующий шаг — расширение на мобильное приложение для iOS и Android (App Store + Google Play). Необходимо принять ряд фундаментальных архитектурных решений о том, как бот и приложение будут сосуществовать, деля общую инфраструктуру.

## Решения

### 1. Монорепозиторий (pnpm workspaces)

**Решение**: Перенести текущий `fit-tel-bot` в монорепозиторий со структурой `apps/bot`, `apps/api`, `apps/mobile`, `packages/shared-types`.

**Обоснование**:

- Общие TypeScript-типы (`ParsedWorkout`, `Exercise`, `User`) между бэкендом и приложением без дублирования
- Единый ESLint/Prettier/tsconfig для всех пакетов
- Синхронный рефакторинг API и клиента в одном PR
- Нет накладных расходов на npm publishing внутренних пакетов

**Альтернатива, которую отвергли**: Отдельные репозитории с npm-пакетом для shared-types — сложнее поддерживать версионирование, медленнее CI.

### 2. Общая База Данных PostgreSQL (Supabase)

**Решение**: Бот и мобильное приложение используют **одну** базу данных. Доступ через общий `WorkoutService`, `ExerciseService`, `UserService`.

**Обоснование**:

- Данные тренировок едины — нет проблемы синхронизации
- Суперсет в боте сразу виден в приложении
- Supabase поддерживает несколько одновременных подключений
- Row Level Security обеспечивает изоляцию между пользователями

**Альтернатива**: Разные БД + репликация — избыточная сложность для текущего масштаба.

### 3. API-First: Fastify REST API

**Решение**: Вынести `WorkoutService`, `ExerciseService`, `UserService` за HTTP API (Fastify). Бот становится клиентом API вместо прямого доступа к БД.

**Обоснование**:

- Единая точка доступа для бота и мобильного приложения
- Явные интерфейсы вместо shared in-process вызовов
- Независимый деплой API и бота
- Swagger автодокументация

**Риск**: Добавляется network hop для бота. Митигация: API на том же хосте (loopback), задержка < 1ms.

### 4. React Native + Expo для мобильного приложения

**Решение**: Мобильное приложение — React Native с Expo SDK.

**Обоснование**:

- TypeScript — общий язык с бэкендом
- Один код для iOS и Android
- Expo EAS для CI/CD и OTA-обновлений
- Богатая экосистема: expo-av, expo-notifications, expo-haptics
- Быстрее Time-to-Market для App MVP

**Ограничения**: При достижении сложных нативных фич (pose estimation, продвинутый аудио) — возможен частичный Native Module или полная миграция на SwiftUI/Kotlin. Принято как допустимый технический долг.

### 5. STT/NLU — HTTP-роуты, не отдельные сервисы (на App MVP)

**Решение**: STT (Deepgram) и NLU (DeepSeek) становятся HTTP-роутами в API-сервисе (`POST /stt/transcribe`, `POST /nlu/parse`), а не отдельными контейнерами.

**Обоснование**:

- STT и NLU уже являются внешними HTTP-вызовами (Deepgram API, DeepSeek API) — физический вынос не меняет изоляцию отказов
- Минимизация операционной сложности на App MVP
- Вынос в отдельный контейнер — Фаза 3 при необходимости горизонтального масштабирования

### 6. Авторизация: JWT + OAuth (Telegram, VK, Google, Apple)

**Решение**: Для мобильного приложения — JWT (access 15 мин, refresh 30 дней) + OAuth через популярные провайдеры. Бот продолжает авторизацию по `telegram_id` без изменений.

**Обоснование**:

- Telegram Login Widget — наиболее удобный вариант для ЦА (русскоязычная аудитория)
- Apple Sign In — обязателен для App Store, если есть другие OAuth
- Таблица `auth_providers` уже спроектирована с поддержкой нескольких провайдеров

## Последствия

- **Положительные**: Единая БД без синхронизации, переиспользование TypeScript-типов, быстрый App MVP, независимый деплой компонент
- **Отрицательные**: Монорепозиторий требует настройки pnpm workspaces, бот переезжает из самостоятельного репозитория
- **Нейтральные**: Текущий деплой (Яндекс Облако VM) расширяется дополнительным API-контейнером, без изменения инфраструктуры

## Связанная документация

- [FIT_APP_SYSTEM_DESIGN.md](../design/FIT_APP_SYSTEM_DESIGN.md) — детальный system design мобильного приложения
- [FIT_APP_BUSINESS_REQUIREMENTS.md](../../../FIT_APP_BUSINESS_REQUIREMENTS.md) — бизнес-требования
