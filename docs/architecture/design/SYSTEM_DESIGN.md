# System Design: Telegram-–±–æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (FitBot)

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [High-Level –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#1-high-level-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [Data Flow: –æ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏](#2-data-flow-–æ—Ç-–≥–æ–ª–æ—Å–æ–≤–æ–≥–æ-—Å–æ–æ–±—â–µ–Ω–∏—è-–¥–æ-–ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
3. [–ú–æ–¥—É–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—á–∏ –∏ —Ç–µ–∫—Å—Ç–∞ (STT / NLU)](#3-–º–æ–¥—É–ª–∏-–æ–±—Ä–∞–±–æ—Ç–∫–∏-—Ä–µ—á–∏-–∏-—Ç–µ–∫—Å—Ç–∞-stt--nlu)
4. [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ö–µ–º–∞ –ë–î](#4-–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö-–∏-—Å—Ö–µ–º–∞-–±–¥)
5. [–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#5-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è-–∏-–º–æ–¥–µ–ª—å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
6. [Telegram-–±–æ—Ç: –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —Å–æ—Å—Ç–æ—è–Ω–∏—è, UX](#6-telegram-–±–æ—Ç-–ø–∞—Ç—Ç–µ—Ä–Ω—ã-—Å–æ—Å—Ç–æ—è–Ω–∏—è-ux)
7. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ –∏ —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏](#7-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏-–∏-—Å–∏–Ω–æ–Ω–∏–º–∞–º–∏)
8. [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã](#8-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã)
9. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å](#9-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å)
10. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#10-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
11. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#11-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)

---

## 1. High-Level –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä—ë—Ö –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å–ª–æ—ë–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞ —ç—Ç–∞–ø–µ MVP –∂–∏–≤—É—Ç **–≤ –æ–¥–Ω–æ–º –º–æ–Ω–æ–ª–∏—Ç–µ**, –Ω–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ —Å —á—ë—Ç–∫–∏–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è.

```mermaid
graph TB
    subgraph "–ö–ª–∏–µ–Ω—Ç—ã"
        TG["üì± Telegram Bot"]
        APP["üì≤ –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br/>(–±—É–¥—É—â–µ–µ)"]
    end

    subgraph "API Gateway (–±—É–¥—É—â–µ–µ)"
        GW["üîÄ API Gateway / BFF"]
    end

    subgraph "Core Services (–º–æ–Ω–æ–ª–∏—Ç –Ω–∞ MVP)"
        BOT["ü§ñ Bot Handler<br/>Telegraf + FSM"]
        STT["üéôÔ∏è STT Service<br/>Whisper API"]
        NLU["üß† NLU Parser<br/>Workout Parser"]
        WRK["üí™ Workout Service<br/>CRUD + Draft flow"]
        EXR["üèãÔ∏è Exercise Registry<br/>–°–∏–Ω–æ–Ω–∏–º—ã + ID"]
        USR["üë§ User Service<br/>Auth + Profile"]
        PUB["üì£ Publisher<br/>–ö–∞–Ω–∞–ª / –ß–∞—Ç"]
    end

    subgraph "–î–∞–Ω–Ω—ã–µ"
        PG["üêò PostgreSQL"]
        REDIS["‚ö° Redis<br/>Sessions + Cache"]
        S3["üì¶ Object Storage<br/>–ê—É–¥–∏–æ (–æ–ø—Ü.)"]
    end

    TG -->|webhook| BOT
    APP -->|REST/gRPC| GW
    GW --> WRK & USR & EXR
    BOT --> STT --> NLU --> WRK
    BOT --> EXR
    BOT --> USR
    WRK --> PUB
    WRK --> PG
    EXR --> PG
    USR --> PG
    BOT --> REDIS
    STT -.->|temp files| S3
```

### –ú–æ–¥—É–ª–∏ –∏ –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –ú–æ–¥—É–ª—å                | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å                                                                               | –Ø–∑—ã–∫                                  |
| --------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------- |
| **Bot Handler**       | –ü—Ä–∏—ë–º updates, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è, FSM, inline-–∫–Ω–æ–ø–∫–∏                                              | Node.js/TS                            |
| **STT Service**       | –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ‚Üí —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è                                            | Node.js/TS (–≤—ã–∑–æ–≤ OpenAI Whisper API) |
| **NLU Parser**        | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–¥–∞—Ç–∞, —Ñ–æ–∫—É—Å, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –ø–æ–¥—Ö–æ–¥—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) | Node.js/TS (+ OpenAI GPT –¥–ª—è NLU)     |
| **Workout Service**   | CRUD —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, draft-flow, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞                                                    | Node.js/TS                            |
| **Exercise Registry** | –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π, —Å–∏–Ω–æ–Ω–∏–º—ã, —É—Ç–æ—á–Ω–µ–Ω–∏—è                                                    | Node.js/TS                            |
| **User Service**      | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø—Ä–æ—Ñ–∏–ª–∏                                                          | Node.js/TS                            |
| **Publisher**         | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª/—á–∞—Ç                                              | Node.js/TS                            |

### –ß—Ç–æ –¥–µ—Ä–∂–∏–º –≤–º–µ—Å—Ç–µ –Ω–∞ MVP, —á—Ç–æ –≤—ã–Ω–æ—Å–∏–º –ø–æ—Ç–æ–º

| –≠—Ç–∞–ø                | –°–æ—Å—Ç–∞–≤                                                                                                   | –ü—Ä–∏—á–∏–Ω–∞                                                    |
| ------------------- | -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| **MVP (—Å–µ–π—á–∞—Å)**    | –û–¥–∏–Ω Node.js-–ø—Ä–æ—Ü–µ—Å—Å = Bot + STT + NLU + Workout + ExerciseRegistry + User + Publisher                   | –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–æ—Å—Ç–æ—Ç–∞ –¥–µ–ø–ª–æ—è, –º–∏–Ω–∏–º—É–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| **v2 (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)** | –í—ã–Ω–æ—Å–∏–º `Workout API` + `Exercise API` + `User API` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π REST-—Å–µ—Ä–≤–∏—Å, –±–æ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º API | –ë–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –±–æ—Ç–æ–º, –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º                   |
| **v3 (–º–∞—Å—à—Ç–∞–±)**    | –í—ã–Ω–æ—Å–∏–º `STT/NLU` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å (Python/Node), –¥–æ–±–∞–≤–ª—è–µ–º `Analytics Service`                   | STT ‚Äî —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∞—è –∑–∞–¥–∞—á–∞, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–±–æ—Ç–∞    |

---

## 2. Data Flow: –æ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

### –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π (Happy Path)

```mermaid
sequenceDiagram
    actor U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant TG as Telegram
    participant BOT as Bot Handler
    participant STT as STT Service
    participant NLU as NLU Parser
    participant WRK as Workout Service
    participant DB as PostgreSQL
    participant PUB as Publisher
    participant CH as –ß–∞—Ç/–ö–∞–Ω–∞–ª

    U->>TG: üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    TG->>BOT: Update (voice)
    BOT->>U: ‚è≥ "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..."
    BOT->>STT: –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å
    STT->>STT: –°–∫–∞—á–∞—Ç—å .oga ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ .wav ‚Üí Whisper API
    STT-->>BOT: –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    BOT->>NLU: –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ç–µ–∫—Å—Ç
    NLU->>NLU: –ò–∑–≤–ª–µ—á—å –¥–∞—Ç—É, —Ñ–æ–∫—É—Å, –º–µ—Å—Ç–æ, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –ø–æ–¥—Ö–æ–¥—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

    alt –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
        NLU-->>BOT: –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ
        BOT->>U: üîò Inline-–∫–Ω–æ–ø–∫–∏: "–ß—Ç–æ –∏–º–µ–Ω–Ω–æ?"
        U->>BOT: –í—ã–±–æ—Ä –∫–Ω–æ–ø–∫–∏
        BOT->>NLU: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤—ã–±–æ—Ä–æ–º
    end

    NLU-->>BOT: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π WorkoutDraft
    BOT->>WRK: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
    WRK->>DB: INSERT workout (status=draft)
    BOT->>U: üìù –ü—Ä–µ–≤—å—é + –∫–Ω–æ–ø–∫–∏ [‚úÖ Approve] [‚úèÔ∏è Edit] [‚ùå Cancel]

    alt ‚úÖ Approve
        U->>BOT: –ù–∞–∂–∞–ª Approve
        BOT->>WRK: –£—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        WRK->>DB: UPDATE status = approved
        BOT->>PUB: –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
        PUB->>CH: üì£ –ö—Ä–∞—Å–∏–≤—ã–π –ø–æ—Å—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        BOT->>TG: –£–¥–∞–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        BOT->>U: ‚úÖ "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!"
    else ‚úèÔ∏è Edit
        U->>BOT: –ù–∞–∂–∞–ª Edit
        BOT->>U: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å –ø—Ä–∞–≤–∫–∞–º–∏"
        U->>BOT: –¢–µ–∫—Å—Ç/–≥–æ–ª–æ—Å —Å –ø—Ä–∞–≤–∫–∞–º–∏
        BOT->>NLU: –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏
        NLU-->>BOT: –î–µ–ª—å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        BOT->>WRK: –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
        BOT->>U: üìù –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –ø—Ä–µ–≤—å—é + –∫–Ω–æ–ø–∫–∏
    else ‚ùå Cancel
        U->>BOT: –ù–∞–∂–∞–ª Cancel
        BOT->>WRK: –£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
        WRK->>DB: DELETE workout
        BOT->>TG: –£–¥–∞–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ
        BOT->>U: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    end
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

STT ‚Äî —Å–∞–º–∞—è ¬´—Ç—è–∂—ë–ª–∞—è¬ª –æ–ø–µ—Ä–∞—Ü–∏—è (2‚Äì10 —Å–µ–∫—É–Ω–¥). –°—Ç—Ä–∞—Ç–µ–≥–∏—è:

| –≠—Ç–∞–ø    | –ü–æ–¥—Ö–æ–¥                                     | –ü–æ—è—Å–Ω–µ–Ω–∏–µ                                                                                            |
| ------- | ------------------------------------------ | ---------------------------------------------------------------------------------------------------- |
| **MVP** | Inline `await` —Å typing-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º        | –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `sendChatAction('typing')` –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫, –ø–æ–∫–∞ –∂–¥—ë—Ç STT |
| **v2**  | Bull/BullMQ-–æ—á–µ—Ä–µ–¥—å –Ω–∞ Redis               | –ó–∞–¥–∞—á–∏ STT —Å—Ç–∞–≤—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å, worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ callback/event      |
| **v3**  | –û—Ç–¥–µ–ª—å–Ω—ã–π STT-–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å + RabbitMQ/Kafka | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç–∫–∞–∑–æ–≤                                                     |

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ø–æ—Ç–æ–∫–µ

```mermaid
graph TD
    A[–ü–æ–ª—É—á–∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ] --> B{–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª}
    B -->|–û—à–∏–±–∫–∞| E1["‚ö†Ô∏è '–ù–µ —Å–º–æ–≥ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑'"]
    B -->|OK| C{STT}
    C -->|–û—à–∏–±–∫–∞| E2["‚ö†Ô∏è '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å, –ø–æ–ø—Ä–æ–±—É–π –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º'"]
    C -->|–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç| E3["‚ö†Ô∏è '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–ª–æ–≤–∞, –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞'"]
    C -->|OK| D{NLU}
    D -->|–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞| E4["‚ö†Ô∏è '–ù–µ —Å–º–æ–≥ –ø–æ–Ω—è—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, –≤–æ—Ç —á—Ç–æ —è —É—Å–ª—ã—à–∞–ª: ...'<br/>–ü–æ–∫–∞–∑—ã–≤–∞–µ–º raw text"]
    D -->|–ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç| E5["üìù –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ + –ø—Ä–æ—Å–∏–º —É—Ç–æ—á–Ω–∏—Ç—å"]
    D -->|OK| F[–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é]
```

---

## 3. –ú–æ–¥—É–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—á–∏ –∏ —Ç–µ–∫—Å—Ç–∞ (STT / NLU)

### 3.1 Speech-to-Text (STT)

#### –í—ã–±–æ—Ä —Å–µ—Ä–≤–∏—Å–∞

| –í–∞—Ä–∏–∞–Ω—Ç                          | –ü–ª—é—Å—ã                                                        | –ú–∏–Ω—É—Å—ã                                    | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è    |
| -------------------------------- | ------------------------------------------------------------ | ----------------------------------------- | --------------- |
| **OpenAI Whisper API** (–æ–±–ª–∞–∫–æ)  | –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä—É—Å—Å–∫–æ–≥–æ, –Ω–µ –Ω—É–∂–µ–Ω GPU | –ü–ª–∞—Ç–Ω—ã–π ($0.006/–º–∏–Ω), –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–µ—Ç–∏ | ‚úÖ **MVP**      |
| **Self-hosted Whisper** (Python) | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å                                   | –ù—É–∂–µ–Ω GPU, —Å–ª–æ–∂–Ω–µ–µ –¥–µ–ø–ª–æ–π                 | –ù–∞ –±—É–¥—É—â–µ–µ (v3) |
| **Google Speech-to-Text**        | –•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, —Å—Ç—Ä–∏–º–∏–Ω–≥                                   | –ü–ª–∞—Ç–Ω—ã–π, —Å–ª–æ–∂–Ω–µ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è               | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞    |

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ STT-–º–æ–¥—É–ª—è

```typescript
// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å STT-—Å–µ—Ä–≤–∏—Å–∞ (Node.js)
interface SttService {
  /**
   * –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –≤ —Ç–µ–∫—Å—Ç
   * @param audioBuffer ‚Äî –±—É—Ñ–µ—Ä –∞—É–¥–∏–æ (.ogg/.wav)
   * @param language ‚Äî —è–∑—ã–∫ ('ru' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   * @returns ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
   */
  transcribe(audioBuffer: Buffer, language?: string): Promise<string>;
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ OpenAI Whisper API
class OpenAiWhisperService implements SttService {
  async transcribe(audioBuffer: Buffer, language = 'ru'): Promise<string> {
    // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º .oga ‚Üí .wav —á–µ—Ä–µ–∑ ffmpeg (node-fluent-ffmpeg)
    // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ OpenAI Whisper API
    // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
  }
}
```

#### –ü–æ—á–µ–º—É –ù–ï –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π Python-–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è STT –Ω–∞ MVP

- –ù–∞ MVP –∏—Å–ø–æ–ª—å–∑—É–µ–º **OpenAI Whisper API** (–æ–±–ª–∞—á–Ω—ã–π) ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ HTTP-–∑–∞–ø—Ä–æ—Å, Python –Ω–µ –Ω—É–∂–µ–Ω
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `openai` npm-–ø–∞–∫–µ—Ç ‚Äî –Ω–∞—Ç–∏–≤–Ω–æ –≤ Node.js
- Python-–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å —Å self-hosted Whisper –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏:
  - –ñ–µ–ª–∞–Ω–∏–∏ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ API ($) –ø—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä—ë–º–µ
  - –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ñ–ª–∞–π–Ω
  - –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö/fine-tuning

### 3.2 NLU / –ü–∞—Ä—Å–∏–Ω–≥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏

#### –ü–æ–¥—Ö–æ–¥: LLM-based structured extraction

–í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ regex/rule-based –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º **OpenAI GPT** (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥) c **structured output** –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

| –ü–æ–¥—Ö–æ–¥                       | –ü–ª—é—Å—ã                                                        | –ú–∏–Ω—É—Å—ã                                            |
| ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------- |
| **LLM (GPT) —Å JSON schema**  | –ü–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Å–∏–Ω–æ–Ω–∏–º—ã, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—É—é —Ä–µ—á—å, ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª | –ü–ª–∞—Ç–Ω—ã–π, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç API, –∑–∞–¥–µ—Ä–∂–∫–∞             |
| **Rule-based (regex + NLP)** | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –±—ã—Å—Ç—Ä–æ, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ                              | –•—Ä—É–ø–∫–æ, –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –≤–∞—Ä–∏–∞—Ü–∏–π, —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å |
| **–ì–∏–±—Ä–∏–¥**                   | –ë–∞–ª–∞–Ω—Å                                                       | –°–ª–æ–∂–Ω–µ–µ –ª–æ–≥–∏–∫–∞                                    |

> [!TIP]
> **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞ MVP ‚Äî —á–∏—Å—Ç—ã–π LLM (GPT-4o-mini / GPT-4.1-nano). –û–Ω –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç ¬´—Å–µ–≥–æ–¥–Ω—è –¥–µ–ª–∞–ª–∞ –ø—Ä–∏—Å–µ–¥ 4 –ø–æ 12 –Ω–∞ 40 –∫–≥, –ø–æ—Ç–æ–º –∂–∏–º –ª—ë–∂–∞ 3 –ø–æ 10 –Ω–∞ 30, –Ω–µ–º–Ω–æ–≥–æ —Ç—è–Ω—É–ª–æ –ø—Ä–∞–≤–æ–µ –∫–æ–ª–µ–Ω–æ¬ª. Rule-based –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å —Ç–∞–∫–∏–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ–º.

#### –ü—Ä–æ–º–ø—Ç –∏ JSON-—Å—Ö–µ–º–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞

```typescript
// –°—Ö–µ–º–∞ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
interface ParsedWorkout {
  date: string; // ISO 8601 –∏–ª–∏ 'today' / 'yesterday'
  focus: WorkoutFocus[]; // ["legs", "glutes"]
  location: WorkoutLocation; // "Alushta_home" | "Sevastopol_triumph"
  exercises: ParsedExercise[];
  comments: ParsedComment[];
}

interface ParsedExercise {
  name: string; // –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–≤–∞–ª
  canonical_name?: string; // –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è (–µ—Å–ª–∏ –∑–Ω–∞–µ–º)
  sets: ParsedSet[];
  is_ambiguous: boolean; // –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ?
  possible_matches?: string[]; // –í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
}

interface ParsedSet {
  reps: number;
  weight?: number; // –∫–≥
  unit?: 'kg' | 'lb';
}

interface ParsedComment {
  type: 'technique' | 'sensation' | 'asymmetry' | 'other';
  exercise_ref?: string; // –ö –∫–∞–∫–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é –æ—Ç–Ω–æ—Å–∏—Ç—Å—è
  body_part?: string;
  side?: 'left' | 'right' | 'both';
  sensation_type?: 'pain' | 'tension' | 'burn';
  raw_text: string;
}
```

#### –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ GPT –ø–µ—Ä–µ–¥–∞—ë–º:

1. **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç** —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∞, –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π `focus`, `location`, —Ç–∏–ø–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
2. **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ –ë–î) ‚Äî —á—Ç–æ–±—ã LLM –º–æ–≥ –º–∞–ø–ø–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã
3. **–ò—Å—Ç–æ—Ä–∏—é —É—Ç–æ—á–Ω–µ–Ω–∏–π** ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã–±–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä. ¬´–ø—Ä–∏—Å–µ–¥¬ª ‚Üí ¬´back squat¬ª)

#### –ú–µ—Ö–∞–Ω–∏–∫–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–π (Disambiguation)

```mermaid
graph TD
    A[NLU —Ä–∞—Å–ø–æ–∑–Ω–∞–ª '–ø—Ä–∏—Å–µ–¥'] --> B{–ï—Å—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ<br/>–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?}
    B -->|–î–∞, –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ| C[–ú–∞–ø–ø–∏–º –Ω–∞ canonical exercise]
    B -->|–ù–µ—Ç –∏–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ| D{–ï—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã?}
    D -->|2+ –≤–∞—Ä–∏–∞–Ω—Ç–∞| E["üîò Inline-–∫–Ω–æ–ø–∫–∏:<br/>1. Back Squat<br/>2. Front Squat<br/>3. Goblet Squat<br/>4. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ"]
    D -->|0 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤| F["üîò –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ?"]
    E --> G[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª]
    G --> H[–°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥<br/>'–ø—Ä–∏—Å–µ–¥' ‚Üí –≤—ã–±—Ä–∞–Ω–Ω—ã–π ID<br/>–¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
```

#### –°–ª–æ–≤–∞—Ä—å —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–∞–ø–ø–∏–Ω–≥–∏

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫**:

1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å** ‚Äî –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π, –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –º–∞–ø–ø–∏–Ω–≥** ‚Äî –ª–∏—á–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, —Ñ–æ—Ä–º–∏—Ä—É–µ–º—ã–µ —á–µ—Ä–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è

```
–ì–ª–æ–±–∞–ª—å–Ω—ã–π:
  "back squat"     ‚Üí exercise_id: 1
  "–ø—Ä–∏—Å–µ–¥"         ‚Üí [exercise_id: 1, exercise_id: 5]  ‚Üê –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ!
  "squat"          ‚Üí [exercise_id: 1, exercise_id: 5]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π (user_id: 42):
  "–ø—Ä–∏—Å–µ–¥"         ‚Üí exercise_id: 1  (Back Squat)
  "–∂–∏–º"            ‚Üí exercise_id: 10 (Bench Press)
```

–ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ ‚Üí –∑–∞—Ç–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π ‚Üí –µ—Å–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ ‚Üí —É—Ç–æ—á–Ω—è–µ–º.

---

## 4. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ö–µ–º–∞ –ë–î

### –í—ã–±–æ—Ä –ë–î

| –ö—Ä–∏—Ç–µ—Ä–∏–π                                                 | PostgreSQL                                | MongoDB                                                               |
| -------------------------------------------------------- | ----------------------------------------- | --------------------------------------------------------------------- |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –ø–æ–¥—Ö–æ–¥—ã, —Å–∏–Ω–æ–Ω–∏–º—ã) | ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, FK, constraints | ‚ö†Ô∏è –ú–æ–∂–Ω–æ, –Ω–æ –Ω–µ—Ç FK, —Å–ª–æ–∂–Ω–µ–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å                              |
| –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏                                   | ‚úÖ JOIN, FK ‚Äî —è–¥—Ä–æ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –ë–î         | ‚ö†Ô∏è Aggregation pipeline, $lookup ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ                          |
| –ì–∏–±–∫–æ—Å—Ç—å —Å—Ö–µ–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤                              | ‚ö†Ô∏è JSONB-–ø–æ–ª—è –¥–ª—è –≥–∏–±–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö           | ‚úÖ –ù–∞—Ç–∏–≤–Ω–æ –≥–∏–±–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã                                           |
| –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (draft ‚Üí approve, —É—Ç–æ—á–Ω–µ–Ω–∏—è)                  | ‚úÖ ACID-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏                        | ‚ö†Ô∏è Multi-document transactions (—Å PostgreSQL 4.0+, –Ω–æ –º–µ–Ω–µ–µ –ø—Ä–∏–≤—ã—á–Ω–æ) |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–±—É–¥—É—â–µ–µ)                                      | ‚úÖ SQL-–∑–∞–ø—Ä–æ—Å—ã, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ç—ã | ‚ö†Ô∏è Aggregation pipeline ‚Äî –º–µ–Ω–µ–µ —É–¥–æ–±–Ω–æ                                |
| ORM/–º–∏–≥—Ä–∞—Ü–∏–∏                                             | ‚úÖ Prisma / Drizzle                       | ‚ö†Ô∏è Mongoose (—Ö—É–∂–µ type-safety)                                        |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ                                          | ‚úÖ Read replicas, partitioning            | ‚úÖ Sharding (–Ω–æ –¥–ª—è –Ω–∞—à–µ–≥–æ –æ–±—ä—ë–º–∞ –Ω–µ –Ω—É–∂–Ω–æ)                           |

> [!IMPORTANT]
> **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: PostgreSQL** ‚Äî –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≥–ª—É–±–æ–∫–æ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ‚Üí –ø–æ–¥—Ö–æ–¥—ã ‚Üí –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏). –î–ª—è –≥–∏–±–∫–∏—Ö –ø–æ–ª–µ–π (–æ—â—É—â–µ–Ω–∏—è, raw_text) –∏—Å–ø–æ–ª—å–∑—É–µ–º `JSONB`. PostgreSQL –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (SQL-–∑–∞–ø—Ä–æ—Å—ã).

### ER-–¥–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
erDiagram
    USERS {
        uuid id PK
        varchar telegram_id UK "Nullable ‚Äî –ø–æ–∑–∂–µ –ø—Ä–∏–≤—è–∂–µ–º"
        varchar telegram_username
        varchar email UK "Nullable ‚Äî –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        varchar password_hash "Nullable ‚Äî –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        varchar display_name
        timestamp created_at
        timestamp updated_at
    }

    AUTH_PROVIDERS {
        uuid id PK
        uuid user_id FK
        varchar provider "telegram | email | google | apple"
        varchar provider_user_id "—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
        jsonb metadata "–¥–æ–ø. –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
        timestamp created_at
    }

    WORKOUTS {
        uuid id PK
        uuid user_id FK
        date workout_date
        varchar status "draft | approved | cancelled"
        varchar[] focus "Array: legs, glutes, etc"
        varchar location "Alushta_home | Sevastopol_triumph"
        text raw_transcript "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"
        integer source_message_id "Telegram message ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
        integer preview_message_id "Telegram message ID –ø—Ä–µ–≤—å—é"
        integer published_message_id "ID –≤ –∫–∞–Ω–∞–ª–µ/—á–∞—Ç–µ"
        timestamp created_at
        timestamp updated_at
    }

    EXERCISES {
        uuid id PK
        varchar canonical_name UK "–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è"
        varchar display_name_ru "–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
        varchar display_name_en "–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º"
        varchar[] muscle_groups "–°–≤—è–∑–∞–Ω–Ω—ã–µ –º—ã—à–µ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã"
        varchar category "compound | isolation | cardio"
        boolean is_global "true = –æ–±—â–∏–π, false = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π"
        uuid created_by FK "Nullable ‚Äî –∫—Ç–æ —Å–æ–∑–¥–∞–ª"
        timestamp created_at
    }

    EXERCISE_SYNONYMS {
        uuid id PK
        uuid exercise_id FK
        varchar synonym "–¢–µ–∫—Å—Ç —Å–∏–Ω–æ–Ω–∏–º–∞ (lowercase)"
        varchar language "ru | en"
        boolean is_global "–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π"
        uuid user_id FK "Nullable ‚Äî –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö"
        timestamp created_at
    }

    USER_EXERCISE_MAPPINGS {
        uuid id PK
        uuid user_id FK
        varchar input_text "–ß—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª"
        uuid exercise_id FK "–ù–∞ —á—Ç–æ –∑–∞–º–∞–ø–ª–µ–Ω–æ"
        integer use_count "–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ"
        timestamp created_at
        timestamp updated_at
    }

    WORKOUT_EXERCISES {
        uuid id PK
        uuid workout_id FK
        uuid exercise_id FK
        integer sort_order "–ü–æ—Ä—è–¥–æ–∫ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ"
        varchar raw_name "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–≤–∞–ª"
        timestamp created_at
    }

    EXERCISE_SETS {
        uuid id PK
        uuid workout_exercise_id FK
        integer set_number
        integer reps
        decimal weight "Nullable"
        varchar unit "kg | lb"
        timestamp created_at
    }

    WORKOUT_COMMENTS {
        uuid id PK
        uuid workout_id FK
        uuid workout_exercise_id FK "Nullable ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—â–∏–π"
        varchar comment_type "technique | sensation | asymmetry | other"
        varchar body_part "Nullable"
        varchar side "left | right | both | Nullable"
        varchar sensation_type "pain | tension | burn | Nullable"
        text raw_text
        timestamp created_at
    }

    USERS ||--o{ AUTH_PROVIDERS : "has"
    USERS ||--o{ WORKOUTS : "creates"
    USERS ||--o{ USER_EXERCISE_MAPPINGS : "has"
    USERS ||--o{ EXERCISE_SYNONYMS : "creates personal"
    WORKOUTS ||--o{ WORKOUT_EXERCISES : "contains"
    WORKOUTS ||--o{ WORKOUT_COMMENTS : "has"
    EXERCISES ||--o{ EXERCISE_SYNONYMS : "has"
    EXERCISES ||--o{ WORKOUT_EXERCISES : "referenced by"
    EXERCISES ||--o{ USER_EXERCISE_MAPPINGS : "mapped to"
    WORKOUT_EXERCISES ||--o{ EXERCISE_SETS : "has"
    WORKOUT_EXERCISES ||--o{ WORKOUT_COMMENTS : "has"
```

### –ò–Ω–¥–µ–∫—Å—ã

```sql
-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –¥–∞—Ç–µ
CREATE INDEX idx_workouts_user_date ON workouts(user_id, workout_date DESC);

-- –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏ NLU)
CREATE INDEX idx_exercise_synonyms_text ON exercise_synonyms(LOWER(synonym));
CREATE INDEX idx_exercise_synonyms_user ON exercise_synonyms(user_id, LOWER(synonym));

-- –ü–æ–∏—Å–∫ –º–∞–ø–ø–∏–Ω–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_user_exercise_mappings_user_text ON user_exercise_mappings(user_id, LOWER(input_text));

-- –ü–æ–¥—Ö–æ–¥—ã –ø–æ workout_exercise
CREATE INDEX idx_exercise_sets_workout_exercise ON exercise_sets(workout_exercise_id, set_number);

-- Telegram user ID lookup
CREATE UNIQUE INDEX idx_auth_providers_provider ON auth_providers(provider, provider_user_id);
```

### ORM

> [!TIP]
> **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: Prisma** ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è type-safety, –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤, –º–∏–≥—Ä–∞—Ü–∏–∏, —É–¥–æ–±–Ω—ã–π query builder. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Äî **Drizzle ORM** (–ª–µ–≥—á–µ, –±–ª–∏–∂–µ –∫ SQL). –î–ª—è MVP Prisma ‚Äî –ª—É—á—à–∏–π –≤—ã–±–æ—Ä.

---

## 5. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –û–±—ä—è—Å–Ω–µ–Ω–∏–µ ¬´–¥–ª—è —Å–∞–º—ã—Ö –º–∞–ª–µ–Ω—å–∫–∏—Ö¬ª üë∂

#### –≠—Ç–∞–ø 1: –¢–æ–ª—å–∫–æ Telegram-–±–æ—Ç

```
–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —ç—Ç–∞–ø–µ –±–æ—Ç–∞:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É –≤ Telegram
2. Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –Ω–∞–º –¥–∞–Ω–Ω—ã–µ: telegram_id = 123456789, username = @liza
3. –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ –≤ –Ω–∞—à–µ–π —Ç–∞–±–ª–∏—Ü–µ users –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º telegram_id?
   - –ï—Å–ª–∏ –ù–ï–¢ ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
   - –ï—Å–ª–∏ –î–ê ‚Üí —ç—Ç–æ –Ω–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–∞–±–æ—Ç–∞–µ–º
4. –í—Å—ë! –ù–∏–∫–∞–∫–∏—Ö –ø–∞—Ä–æ–ª–µ–π, –ª–æ–≥–∏–Ω–æ–≤, email ‚Äî Telegram —Å–∞–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π —á–µ–ª–æ–≤–µ–∫
```

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ:**

| –ü–æ–ª–µ           | –ü—Ä–∏–º–µ—Ä               | –ó–∞—á–µ–º                            |
| -------------- | -------------------- | -------------------------------- |
| `id`           | `uuid: 550e8400-...` | –ù–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID (–Ω–µ Telegram!) |
| `display_name` | `"–õ–∏–∑–∞"`             | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö        |
| `created_at`   | `2026-02-21`         | –ö–æ–≥–¥–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è          |

| –ü–æ–ª–µ –≤ auth_providers | –ü—Ä–∏–º–µ—Ä               | –ó–∞—á–µ–º           |
| --------------------- | -------------------- | --------------- |
| `user_id`             | `uuid: 550e8400-...` | –°—Å—ã–ª–∫–∞ –Ω–∞ users |
| `provider`            | `"telegram"`         | –¢–∏–ø –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞  |
| `provider_user_id`    | `"123456789"`        | Telegram ID     |

#### –≠—Ç–∞–ø 2: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```
–ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞ (user_id = 550e...).
–¢–µ–ø–µ—Ä—å –æ–Ω —Å–∫–∞—á–∞–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å –¥–≤–∞ –∞–∫–∫–∞—É–Ω—Ç–∞?

–†–µ—à–µ–Ω–∏–µ: –ü–∞—Ç—Ç–µ—Ä–Ω "Link Account"

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ email/Google/Apple ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –ù–û–í–ê–Ø –∑–∞–ø–∏—Å—å –≤ auth_providers:
   provider = "email", provider_user_id = "liza@gmail.com"
   ‚Üë –Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Ç–æ–º—É –∂–µ user_id!

3. –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å? –í–∞—Ä–∏–∞–Ω—Ç—ã:

   –í–∞—Ä–∏–∞–Ω—Ç –ê: "–ü—Ä–∏–≤—è–∑–∞—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞" (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   –∞) –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∫–Ω–æ–ø–∫–∞ "–°–≤—è–∑–∞—Ç—å —Å Telegram"
   –±) –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥: ABC-123
   –≤) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–æ—Ç—É: /link ABC-123
   –≥) –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç
   –¥) –¢–µ–ø–µ—Ä—å: –æ–¥–∏–Ω user_id, –¥–≤–µ –∑–∞–ø–∏—Å–∏ –≤ auth_providers:
      - provider=telegram, provider_user_id=123456789
      - provider=email, provider_user_id=liza@gmail.com

   –í–∞—Ä–∏–∞–Ω—Ç –ë: Telegram Login Widget
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   –∞) –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∫–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"
   –±) Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ª–∏—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ OAuth-–ø–æ–¥–æ–±–Ω—ã–π flow
   –≤) –ú—ã –ø–æ–ª—É—á–∞–µ–º telegram_id ‚Üí –Ω–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º
```

#### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏

```mermaid
graph LR
    subgraph "–û–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ (user_id = 550e...)"
        U["üë§ User<br/>id: 550e...<br/>name: –õ–∏–∑–∞"]
    end

    subgraph "–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (auth_providers)"
        T["üì± Telegram<br/>provider: telegram<br/>id: 123456789"]
        E["üìß Email<br/>provider: email<br/>id: liza@gmail.com"]
        G["üçé Apple<br/>provider: apple<br/>id: apple-sub-xxx"]
    end

    T --> U
    E --> U
    G --> U
```

#### JWT –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
–î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email + –ø–∞—Ä–æ–ª—å (–∏–ª–∏ OAuth —á–µ—Ä–µ–∑ Google/Apple)
2. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –≤—ã–¥–∞—ë—Ç JWT-—Ç–æ–∫–µ–Ω
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ—Å—ã–ª–∞–µ—Ç –µ–≥–æ –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:
   Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
4. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω ‚Üí –∑–Ω–∞–µ—Ç user_id ‚Üí –æ—Ç–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ

–î–ª—è Telegram-–±–æ—Ç–∞ JWT –ù–ï –Ω—É–∂–µ–Ω ‚Äî Telegram —Å–∞–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ª–∏—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Å–≤–æ–∏ update'—ã.
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —ç—Ç–∞–ø–∞–º

| –≠—Ç–∞–ø                | –ú–µ—Ö–∞–Ω–∏–∑–º                                | –î–µ—Ç–∞–ª–∏                                                                  |
| ------------------- | --------------------------------------- | ----------------------------------------------------------------------- |
| **MVP (–±–æ—Ç)**       | Telegram user_id –∏–∑ update              | –ë–µ–∑ –ø–∞—Ä–æ–ª–µ–π, –±–µ–∑ JWT. –ü—Ä–æ—Å—Ç–æ `ctx.from.id`                              |
| **v2 (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)** | JWT + refresh tokens                    | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è email/pass, OAuth (Google, Apple). –î–ª—è –±–æ—Ç–∞ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| **v2 (—Å–≤—è–∑–∫–∞)**     | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ / Telegram Login Widget | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤                                                   |

---

## 6. Telegram-–±–æ—Ç: –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —Å–æ—Å—Ç–æ—è–Ω–∏—è, UX

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥: FSM (Finite State Machine)

–ò—Å–ø–æ–ª—å–∑—É–µ–º **grammY** (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è TypeScript-native –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Telegraf) —Å –ø–ª–∞–≥–∏–Ω–æ–º `@grammyjs/conversations` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–∞.

> [!NOTE]
> **–ü–æ—á–µ–º—É grammY, –∞ –Ω–µ Telegraf:**
>
> - –õ—É—á—à–∞—è type-safety (Telegraf –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∞–º–∏ –≤ v4+)
> - –ü–ª–∞–≥–∏–Ω conversations ‚Äî –º–æ—â–Ω—ã–π FSM –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
> - –ê–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ, —Ö–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
> - –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ –≤—Å–µ–º–∏ —Ñ–∏—á–∞–º–∏ Telegram Bot API

#### –°–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞ (FSM)

```mermaid
stateDiagram-v2
    [*] --> Idle

    Idle --> ProcessingVoice: –ü–æ–ª—É—á–∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ
    Idle --> ProcessingText: –ü–æ–ª—É—á–∏–ª–∏ —Ç–µ–∫—Å—Ç
    Idle --> EditingByDate: /edit + –¥–∞—Ç–∞

    ProcessingVoice --> WaitingForSTT: –û—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤ STT
    WaitingForSTT --> Parsing: –ü–æ–ª—É—á–∏–ª–∏ —Ç–µ–∫—Å—Ç
    ProcessingText --> Parsing: –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é

    Parsing --> Disambiguating: –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
    Disambiguating --> Parsing: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª
    Parsing --> DraftReady: –í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã

    DraftReady --> Idle: ‚ùå Cancel
    DraftReady --> Editing: ‚úèÔ∏è Edit
    DraftReady --> Publishing: ‚úÖ Approve

    Editing --> ProcessingEditVoice: –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å –ø—Ä–∞–≤–∫–∞–º–∏
    Editing --> ProcessingEditText: –¢–µ–∫—Å—Ç —Å –ø—Ä–∞–≤–∫–∞–º–∏
    ProcessingEditVoice --> WaitingForSTT
    ProcessingEditText --> Parsing

    EditingByDate --> Editing: –ù–∞—à–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É

    Publishing --> Idle: –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ handlers

```
src/
  bot/
    bot.ts                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è grammY –±–æ—Ç–∞
    conversations/
      newWorkout.ts           # FSM –¥–ª—è –Ω–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      editWorkout.ts          # FSM –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      disambiguateExercise.ts # FSM –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
      linkAccount.ts          # FSM –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
    handlers/
      voiceHandler.ts         # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö
      textHandler.ts          # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
      callbackHandler.ts      # Inline-–∫–Ω–æ–ø–∫–∏ callbacks
    keyboards/
      workoutPreview.ts       # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–µ–≤—å—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      exercisePicker.ts       # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      editMenu.ts             # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    formatters/
      workoutFormatter.ts     # –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    middleware/
      authMiddleware.ts       # –ü—Ä–æ–≤–µ—Ä–∫–∞/—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      errorMiddleware.ts      # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      loggingMiddleware.ts    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### Workflow Draft ‚Üí Approve ‚Üí Edit ‚Üí Cancel

#### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞

```typescript
// –ß–µ—Ä–Ω–æ–≤–∏–∫ —Ö—Ä–∞–Ω–∏—Ç—Å—è –í –ë–î (—Ç–∞–±–ª–∏—Ü–∞ workouts, status = 'draft')
// + message_id –ø—Ä–µ–≤—å—é —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ workout.preview_message_id
// + Redis session –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π conversation state

// –ö–ª—é—á–∏ Redis session:
// session:{chatId} ‚Üí { conversationState, currentDraftId, disambiguation }
```

#### Inline-–∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–≤—å—é

```typescript
// keyboards/workoutPreview.ts
import { InlineKeyboard } from 'grammy';

const previewKeyboard = (workoutId: string) =>
  new InlineKeyboard()
    .text('‚úÖ Approve', `approve:${workoutId}`)
    .text('‚úèÔ∏è Edit', `edit:${workoutId}`)
    .text('‚ùå Cancel', `cancel:${workoutId}`);
```

#### –ü—Ä–∏–º–µ—Ä –ø—Ä–µ–≤—å—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏

```
üìÖ 21.02.2026 | üè† Alushta Home
üéØ Legs, Glutes

1Ô∏è‚É£ Back Squat
   ‚Ä¢ 4 √ó 12 @ 40 –∫–≥
   ‚Ä¢ üí¨ technique: –≥–ª—É–±–∏–Ω–∞ —Ö–æ—Ä–æ—à–∞—è

2Ô∏è‚É£ Romanian Deadlift
   ‚Ä¢ 3 √ó 10 @ 35 –∫–≥
   ‚Ä¢ ‚ö†Ô∏è sensation: —Ç—è–Ω—É—â–µ–µ –æ—â—É—â–µ–Ω–∏–µ, –ø—Ä–∞–≤–æ–µ –±–µ–¥—Ä–æ

3Ô∏è‚É£ Hip Thrust
   ‚Ä¢ 4 √ó 15 @ 50 –∫–≥

[‚úÖ Approve] [‚úèÔ∏è Edit] [‚ùå Cancel]
```

### –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∑–∞ 19 —Ñ–µ–≤—Ä–∞–ª—è"

–ë–æ—Ç:
1. –ò—â–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ 19.02
2. –ï—Å–ª–∏ –Ω–∞—à—ë–ª ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é + "–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å?"
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç/–≥–æ–ª–æ—Å:
   "–ó–∞–º–µ–Ω–∏ –≤–µ—Å –≤ –ø—Ä–∏—Å–µ–¥–µ –Ω–∞ 45 –∫–≥, –¥–æ–±–∞–≤—å —Ä–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥ 3 –ø–æ 15"
4. NLU –ø–∞—Ä—Å–∏—Ç –∫–∞–∫ –¥–µ–ª—å—Ç—É ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –ø—Ä–µ–≤—å—é + –∫–Ω–æ–ø–∫–∏ [‚úÖ Approve] [‚ùå Cancel]
```

---

## 7. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ –∏ —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏

### –°–∏—Å—Ç–µ–º–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID

–ö–∞–∂–¥–æ–µ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç UUID. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±—ã–≤–∞—é—Ç:

- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ** (`is_global = true`) ‚Äî –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ, –æ–±—â–∏–µ
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ** (`is_global = false`) ‚Äî —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è

```mermaid
graph TD
    A["–í—Ö–æ–¥–Ω–æ–µ —Å–ª–æ–≤–æ: '–ø—Ä–∏—Å–µ–¥'"] --> B["LOWER + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è"]
    B --> C{"–ü–æ–∏—Å–∫ –≤ user_exercise_mappings<br/>(–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)"}
    C -->|–ù–∞–π–¥–µ–Ω| D["‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º exercise_id<br/>use_count++"]
    C -->|–ù–µ –Ω–∞–π–¥–µ–Ω| E{"–ü–æ–∏—Å–∫ –≤ exercise_synonyms<br/>(user_id = current OR is_global)"}
    E -->|1 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ| D
    E -->|2+ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π| F["‚ö†Ô∏è –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ ‚Üí inline-–∫–Ω–æ–ø–∫–∏"]
    E -->|0 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π| G{"–ù–µ—á—ë—Ç–∫–∏–π –ø–æ–∏—Å–∫<br/>(Levenshtein / trigram)"}
    G -->|–ï—Å—Ç—å –ø–æ—Ö–æ–∂–∏–µ| F
    G -->|–ù–∏—á–µ–≥–æ| H["‚ûï –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ"]
    F -->|–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª| I["–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ user_exercise_mappings"]
    I --> D
    H -->|–°–æ–∑–¥–∞–ª| J["–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ + —Å–∏–Ω–æ–Ω–∏–º"]
    J --> D
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

```
exercises (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫):
  id: uuid
  canonical_name: "back_squat"        ‚Üê —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
  display_name_ru: "–ü—Ä–∏—Å–µ–¥ —Å–æ —à—Ç–∞–Ω–≥–æ–π"
  display_name_en: "Back Squat"
  muscle_groups: ["quadriceps", "glutes", "hamstrings"]
  category: "compound"

exercise_synonyms (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã):
  synonym: "–ø—Ä–∏—Å–µ–¥ —Å–æ —à—Ç–∞–Ω–≥–æ–π" ‚Üí exercise_id: back_squat
  synonym: "back squat"        ‚Üí exercise_id: back_squat
  synonym: "–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è"        ‚Üí exercise_id: back_squat

user_exercise_mappings (–ª–∏—á–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏):
  user_id: 42
  input_text: "–ø—Ä–∏—Å–µ–¥"         ‚Üí exercise_id: back_squat  (use_count: 15)
```

–î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è:

- –ù–æ–≤—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `exercise_synonyms` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- –ù–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ‚Äî —á–µ—Ä–µ–∑ INSERT –≤ `exercises` + —Å–∏–Ω–æ–Ω–∏–º—ã
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç—Ä–æ–∏—Ç —Å–≤–æ–π –ª–∏—á–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ¬´–ø—Ä–æ–º–æ—É—Ç–∏–Ω–≥¬ª –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö user_mappings –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–∏–Ω–æ–Ω–∏–º—ã (–±—É–¥—É—â–µ–µ)

---

## 8. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è —ç–≤–æ–ª—é—Ü–∏–∏

```mermaid
graph LR
    subgraph "–≠—Ç–∞–ø 1: MVP (1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)"
        M["üü¢ –ú–æ–Ω–æ–ª–∏—Ç<br/>Node.js<br/>Bot + STT + NLU<br/>+ Workout + User<br/>+ Publisher"]
        PG1["PostgreSQL"]
        R1["Redis"]
        M --> PG1
        M --> R1
    end

    subgraph "–≠—Ç–∞–ø 2: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–¥–µ—Å—è—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"
        BOT2["ü§ñ Bot Service"]
        API2["üî∑ Workout API<br/>(REST)"]
        PG2["PostgreSQL"]
        R2["Redis"]
        APP2["üì± Mobile App"]
        BOT2 --> API2
        APP2 --> API2
        API2 --> PG2
        BOT2 --> R2
    end

    subgraph "–≠—Ç–∞–ø 3: –ú–∞—Å—à—Ç–∞–± (—Å–æ—Ç–Ω–∏+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"
        BOT3["ü§ñ Bot"]
        GW3["üîÄ API GW"]
        STT3["üéôÔ∏è STT/NLU<br/>Service"]
        API3["üî∑ Workout API"]
        AN3["üìä Analytics"]
        Q3["üì¨ Message Queue"]
        PG3["PostgreSQL<br/>(replicas)"]
        R3["Redis Cluster"]
        BOT3 --> GW3
        GW3 --> API3 & AN3
        BOT3 --> Q3 --> STT3
        STT3 --> API3
        API3 --> PG3
    end
```

### –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –≤—ã–Ω–æ—Å–∞ STT/NLU –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å

| –ê—Å–ø–µ–∫—Ç                   | –í –º–æ–Ω–æ–ª–∏—Ç–µ                        | –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å                         |
| ------------------------ | --------------------------------- | ---------------------------------------- |
| **–ü—Ä–æ—Å—Ç–æ—Ç–∞**             | ‚úÖ –û–¥–∏–Ω –¥–µ–ø–ª–æ–π                    | ‚ùå Docker Compose / k8s                  |
| **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–µ–ø–ª–æ—è** | ‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ STT = —Ä–µ–¥–µ–ø–ª–æ–π –≤—Å–µ–≥–æ | ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º STT –æ—Ç–¥–µ–ª—å–Ω–æ                |
| **Python ML**            | ‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ (–º—ã –Ω–∞ Node)        | ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Python-–º–æ–¥–µ–ª–∏      |
| **–†–µ—Å—É—Ä—Å—ã**              | ‚ö†Ô∏è STT —Å—ä–µ–¥–∞–µ—Ç RAM/CPU –±–æ—Ç–∞       | ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –º–æ–∂–Ω–æ –¥–∞—Ç—å GPU |
| **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**   | ‚ö†Ô∏è –ü–∞–¥–µ–Ω–∏–µ STT = –ø–∞–¥–µ–Ω–∏–µ –±–æ—Ç–∞     | ‚úÖ Graceful degradation                  |
| **Shared codebase**      | ‚úÖ –û–±—â–∏–µ —Ç–∏–ø—ã, –±–µ–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏   | ‚ùå –ù—É–∂–µ–Ω API / –ø—Ä–æ—Ç–æ–±—É—Ñ / DTO            |

> [!IMPORTANT]
> **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞ MVP ‚Äî –º–æ–Ω–æ–ª–∏—Ç. STT —á–µ—Ä–µ–∑ OpenAI API (HTTP-–≤—ã–∑–æ–≤) —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —É–∂–µ ¬´–≤—ã–Ω–µ—Å–µ–Ω¬ª ‚Äî –º—ã –ø—Ä–æ—Å—Ç–æ –¥—ë—Ä–≥–∞–µ–º –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å. –í—ã–Ω–æ—Å–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ self-hosted Whisper (GPU, Python).

### –ö–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –±–æ—Ç –¥–µ–ª—è—Ç –±–∞–∑—É

```
–í–∞—Ä–∏–∞–Ω—Ç 1 (MVP ‚Üí v2): –û–±—â–∞—è –±–∞–∑–∞, Workout API
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Bot ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ Workout Service –Ω–∞–ø—Ä—è–º—É—é (in-process)
App ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç Workout API (HTTP/REST)

Workout Service –≤–Ω—É—Ç—Ä–∏ API = –æ–¥–Ω–∞ –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞, –æ–¥–Ω–∞ –ë–î

–í–∞—Ä–∏–∞–Ω—Ç 2 (v3): –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Bot ‚Üí HTTP ‚Üí API Gateway ‚Üí Workout API ‚Üí PostgreSQL
App ‚Üí HTTP ‚Üí API Gateway ‚Üí Workout API ‚Üí PostgreSQL

–¢–∞ –∂–µ –±–∞–∑–∞, –Ω–æ –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ API. Bot –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –Ω–∞–ø—Ä—è–º—É—é —Ç—Ä–æ–≥–∞—Ç—å –ë–î.
```

---

## 9. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

| –°–µ–∫—Ä–µ—Ç               | –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å                   | –ö–∞–∫                                               |
| -------------------- | ----------------------------- | ------------------------------------------------- |
| `BOT_TOKEN`          | `.env` ‚Üí –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è | **–ù–∏–∫–æ–≥–¥–∞** –≤ –∫–æ–¥–µ, –≤ git = `.env` –≤ `.gitignore` |
| `OPENAI_API_KEY`     | `.env` ‚Üí –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è | –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ                                        |
| `DATABASE_URL`       | `.env` ‚Üí –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è | –í–∫–ª—é—á–∞–µ—Ç –ø–∞—Ä–æ–ª—å                                   |
| JWT —Å–µ–∫—Ä–µ—Ç (–±—É–¥—É—â–µ–µ) | `.env` ‚Üí –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è | 256+ –±–∏—Ç —ç–Ω—Ç—Ä–æ–ø–∏–∏                                 |

–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

- Docker secrets / Kubernetes secrets
- Vault (HashiCorp) ‚Äî –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

| –î–∞–Ω–Ω—ã–µ                        | –£—Ä–æ–≤–µ–Ω—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏  | –ó–∞—â–∏—Ç–∞                                                           |
| ----------------------------- | ------------------------- | ---------------------------------------------------------------- |
| Telegram ID                   | –ù–∏–∑–∫–∏–π                    | –•—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å                                                |
| –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –≤–µ—Å–∞) | –°—Ä–µ–¥–Ω–∏–π                   | –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É (WHERE user_id = ?)                      |
| –û—â—É—â–µ–Ω–∏—è, –±–æ–ª–∏ (sensations)   | **–í—ã—Å–æ–∫–∏–π** (–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ) | –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É, –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî hard delete |
| –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã                    | –í—ã—Å–æ–∫–∏–π                   | **–ù–µ —Ö—Ä–∞–Ω–∏–º!** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –ø–∞–º—è—Ç–∏ ‚Üí —É–¥–∞–ª—è–µ–º                   |

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```
1. Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç file_id
2. –ë–æ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç .oga –≤ Buffer (–≤ –ø–∞–º—è—Ç–∏, –ù–ï –Ω–∞ –¥–∏—Å–∫)
3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ .wav (—á–µ—Ä–µ–∑ ffmpeg, pipe ‚Äî –±–µ–∑ temp —Ñ–∞–π–ª–æ–≤)
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ OpenAI Whisper API
5. –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç ‚Üí Buffer —Å—Ä–∞–∑—É GC'd
6. –ü–æ—Å–ª–µ approve/cancel ‚Üí –≤—ã–∑—ã–≤–∞–µ–º bot.api.deleteMessage() –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
7. –ê—É–¥–∏–æ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Üí –Ω–µ—á–µ–≥–æ —É—Ç–µ–∫–∞—Ç—å
```

> [!CAUTION]
> –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞—É–¥–∏–æ (–¥–ª—è –¥–µ–±–∞–≥–∞ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞), —Ö—Ä–∞–Ω–∏—Ç—å –≤ Object Storage (S3/MinIO) —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º at-rest –∏ TTL (–∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π).

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î

- Application-level: –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ `user_id` (Row Level Security –≤ PostgreSQL –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ä–∞)
- Network-level: –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π —Å–µ—Ç–∏ (Docker network / VPC)
- Credentials: –æ—Ç–¥–µ–ª—å–Ω—ã–π DB-user –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏ (`SELECT, INSERT, UPDATE, DELETE` ‚Äî –±–µ–∑ `DROP, ALTER`)

---

## 10. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å

| –°–æ–±—ã—Ç–∏–µ                        | –£—Ä–æ–≤–µ–Ω—å | –ü—Ä–∏–º–µ—Ä                                                       |
| ------------------------------ | ------- | ------------------------------------------------------------ |
| –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å             | `info`  | `User registered: telegram_id=123456`                        |
| –ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ             | `info`  | `Voice received: user=123456, duration=15s`                  |
| STT —É—Å–ø–µ—Ö                      | `info`  | `STT completed: user=123456, text_length=200`                |
| STT –æ—à–∏–±–∫–∞                     | `error` | `STT failed: user=123456, error=timeout`                     |
| NLU: –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ | `warn`  | `Unknown exercise: user=123456, text='—Å—Ç—Ä–∞–Ω–Ω–æ–µ_—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'`  |
| NLU: —É—Ç–æ—á–Ω–µ–Ω–∏–µ                 | `info`  | `Disambiguation: user=123456, input='–ø—Ä–∏—Å–µ–¥', options=[1,5]` |
| Draft —Å–æ–∑–¥–∞–Ω                   | `info`  | `Draft created: workout_id=xxx`                              |
| Approve                        | `info`  | `Workout approved: workout_id=xxx`                           |
| Cancel                         | `info`  | `Workout cancelled: workout_id=xxx`                          |
| Edit                           | `info`  | `Workout edited: workout_id=xxx, changes={...}`              |
| –ü—É–±–ª–∏–∫–∞—Ü–∏—è                     | `info`  | `Published to channel: workout_id=xxx, message_id=789`       |
| –û—à–∏–±–∫–∞ –ë–î                      | `error` | `DB error: query=INSERT..., error=connection refused`        |
| Unhandled error                | `fatal` | `Unhandled error in handler: ...stack trace...`              |

### –õ–æ–≥–≥–µ—Ä

```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º pino ‚Äî —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π JSON-–ª–æ–≥–≥–µ—Ä –¥–ª—è Node.js
import pino from 'pino';

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport:
    process.env.NODE_ENV !== 'production'
      ? { target: 'pino-pretty', options: { colorize: true } }
      : undefined,
  // –í production ‚Üí JSON ‚Üí –º–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å –≤ ELK/Loki
});
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (MVP ‚Üí v2)

| –≠—Ç–∞–ø    | –ü–æ–¥—Ö–æ–¥                               | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã                                    |
| ------- | ------------------------------------ | ---------------------------------------------- |
| **MVP** | –õ–æ–≥–∏ + health endpoint + Uptime Kuma | `pino` ‚Üí stdout ‚Üí –ø—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–µ–∑ `docker logs` |
| **v2**  | –ú–µ—Ç—Ä–∏–∫–∏ + –¥–∞—à–±–æ—Ä–¥                    | Prometheus + Grafana (–∏–ª–∏ Datadog Free)        |
| **v3**  | –ü–æ–ª–Ω—ã–π observability                 | Prometheus + Grafana + Jaeger (tracing)        |

–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

- `stt_duration_seconds` ‚Äî –≤—Ä–µ–º—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
- `nlu_parse_duration_seconds` ‚Äî –≤—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- `workouts_created_total` ‚Äî —Å—á—ë—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- `workouts_approved_total` / `cancelled_total`
- `disambiguation_count` ‚Äî —á–∞—Å—Ç–æ—Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–π
- `errors_total` ‚Äî –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
const errorHandler = {
  // STT –æ—à–∏–±–∫–∞ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥
  sttError: async (ctx, error) => {
    logger.error({ error, userId: ctx.from.id }, 'STT failed');
    await ctx.reply(
      '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π:\n' +
        '‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ –µ—â—ë —Ä–∞–∑\n' +
        '‚Ä¢ –ò–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É —Ç–µ–∫—Å—Ç–æ–º',
    );
  },

  // NLU –æ—à–∏–±–∫–∞ ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å raw text
  nluError: async (ctx, rawText, error) => {
    logger.error({ error, rawText, userId: ctx.from.id }, 'NLU parse failed');
    await ctx.reply(
      '‚ö†Ô∏è –ù–µ —Å–º–æ–≥ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏–∑ —Ç–µ–∫—Å—Ç–∞.\n' +
        `–í–æ—Ç —á—Ç–æ —è —É—Å–ª—ã—à–∞–ª:\n\n_${rawText}_\n\n` +
        '–ü–æ–ø—Ä–æ–±—É–π –æ–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –ø—Ä–æ—â–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º.',
      { parse_mode: 'Markdown' },
    );
  },

  // DB –æ—à–∏–±–∫–∞ ‚Üí retry + user notification
  dbError: async (ctx, error) => {
    logger.error({ error, userId: ctx.from.id }, 'Database error');
    // Retry 1 —Ä–∞–∑ —á–µ—Ä–µ–∑ 2 —Å–µ–∫
    // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –æ—à–∏–±–∫–∞ ‚Üí —Å–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.reply('‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.');
  },
};
```

---

## 11. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–µ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è              | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è                        | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ                                                          |
| ---------------------- | --------------------------------- | -------------------------------------------------------------------- |
| **–Ø–∑—ã–∫**               | TypeScript (Node.js)              | Type-safety, –µ–¥–∏–Ω—ã–π —Å—Ç–µ–∫, —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞                                 |
| **Runtime**            | Node.js 20 LTS                    | –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞                                               |
| **Telegram Bot**       | **grammY**                        | TypeScript-native, conversations plugin –¥–ª—è FSM, –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ |
| **STT**                | OpenAI Whisper API                | –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ, –ø—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è                   |
| **NLU / –ü–∞—Ä—Å–∏–Ω–≥**      | OpenAI GPT-4o-mini / GPT-4.1-nano | Structured output, –ø–æ–Ω–∏–º–∞–µ—Ç –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—É—é —Ä–µ—á—å                        |
| **–ë–î**                 | PostgreSQL 16                     | –†–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, JSONB, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å                     |
| **ORM**                | Prisma                            | Type-safety, –º–∏–≥—Ä–∞—Ü–∏–∏, –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è                                 |
| **–ö—ç—à/–°–µ—Å—Å–∏–∏**         | Redis                             | –ë—ã—Å—Ç—Ä—ã–π, in-memory, pub/sub                                          |
| **–û—á–µ—Ä–µ–¥—å (v2)**       | BullMQ (–Ω–∞ Redis)                 | –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ STT, retry, delay                                     |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è**          | Zod                               | Runtime type validation, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TS                             |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**        | pino                              | –°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –¥–ª—è Node.js, JSON output                               |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**       | Jest                              | –ú–æ–∫-—Ç–µ—Å—Ç—ã, coverage                                                  |
| **–õ–∏–Ω—Ç–µ—Ä**             | ESLint + Prettier                 | –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞                                                        |
| **–ê—É–¥–∏–æ**              | fluent-ffmpeg                     | –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è .oga ‚Üí .wav                                              |
| **HTTP (–±—É–¥—É—â–µ–µ API)** | Fastify                           | –ë—ã—Å—Ç—Ä–µ–µ Express, schema validation                                   |
| **–î–µ–ø–ª–æ–π**             | Docker + Docker Compose           | –ü—Ä–æ—Å—Ç–æ–π MVP-–¥–µ–ø–ª–æ–π                                                   |

### –ß—Ç–æ –Ω–∞ Python?

> [!NOTE]
> **–ù–∞ MVP ‚Äî –Ω–∏—á–µ–≥–æ.** OpenAI Whisper API –∏ GPT API –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ HTTP –∏–∑ Node.js.
>
> Python –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–∑–∂–µ –¥–ª—è:
>
> - **Self-hosted Whisper** (–µ—Å–ª–∏ —Ö–æ—Ç–∏–º —É–π—Ç–∏ –æ—Ç –ø–ª–∞—Ç–Ω–æ–≥–æ API)
> - **–ö–∞—Å—Ç–æ–º–Ω—ã–µ ML-–º–æ–¥–µ–ª–∏** –¥–ª—è NLU (fine-tuned –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)
> - **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** (numpy/pandas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã)
>
> –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ: HTTP REST API (Python FastAPI ‚Üê ‚Üí Node.js Fastify) –∏–ª–∏ gRPC –¥–ª—è high-throughput.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
fit-tel-bot/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma              # –°—Ö–µ–º–∞ –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ migrations/                # –ú–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ bot/                       # Telegram-–±–æ—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bot.ts                 # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è grammY
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conversations/         # FSM-–¥–∏–∞–ª–æ–≥–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/              # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keyboards/             # Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ formatters/            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware/            # Bot middleware
‚îÇ   ‚îú‚îÄ‚îÄ services/                  # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ workout.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exercise.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ publisher.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ stt/                       # Speech-to-Text
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stt.interface.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ openai-whisper.stt.ts
‚îÇ   ‚îú‚îÄ‚îÄ nlu/                       # NLU / –ü–∞—Ä—Å–∏–Ω–≥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nlu.interface.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ workout-parser.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ workout-parse.prompt.ts
‚îÇ   ‚îú‚îÄ‚îÄ repositories/              # –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ workout.repository.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exercise.repository.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ config/                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis.ts
‚îÇ   ‚îú‚îÄ‚îÄ errors/                    # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –æ—à–∏–±–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app-errors.ts
‚îÇ   ‚îú‚îÄ‚îÄ logger/                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                   # Entry point
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ fixtures/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .eslintrc.js
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ jest.config.ts
‚îî‚îÄ‚îÄ package.json
```

### Docker Compose (dev)

```yaml
version: '3.8'
services:
  bot:
    build: .
    env_file: .env
    depends_on:
      - postgres
      - redis
    volumes:
      - ./src:/app/src

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: fitbot
      POSTGRES_USER: fitbot
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - '5432:5432'

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - '6379:6379'

volumes:
  pgdata:
```

### CI/CD (–±–∞–∑–æ–≤—ã–π)

```
GitHub Actions:
1. lint (ESLint)
2. test (Jest)
3. build (tsc)
4. Docker build + push ‚Üí Registry
5. Deploy ‚Üí VPS via SSH (Docker Compose pull + up)

–û–∫—Ä—É–∂–µ–Ω–∏—è:
  dev   ‚Üí –ª–æ–∫–∞–ª—å–Ω–æ (Docker Compose)
  stage ‚Üí VPS —Å test-–±–æ—Ç–æ–º (–æ—Ç–¥–µ–ª—å–Ω—ã–π BOT_TOKEN)
  prod  ‚Üí VPS —Å production-–±–æ—Ç–æ–º
```

---

## –ò—Ç–æ–≥–æ: –¥–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞

| –≠—Ç–∞–ø     | –ß—Ç–æ –¥–µ–ª–∞–µ–º                                          | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å   |
| -------- | --------------------------------------------------- | -------------- |
| **MVP**  | –ë–æ—Ç: –≥–æ–ª–æ—Å ‚Üí draft ‚Üí approve ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è           | 2-3 –Ω–µ–¥–µ–ª–∏     |
| **MVP+** | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∏–Ω–æ–Ω–∏–º—ã, —É—Ç–æ—á–Ω–µ–Ω–∏—è                 | 1-2 –Ω–µ–¥–µ–ª–∏     |
| **v2**   | REST API –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | 2-3 –Ω–µ–¥–µ–ª–∏     |
| **v3**   | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, self-hosted STT, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ         | –ü–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ |

---

## 12. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –∫–æ–¥–∞ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

### 12.1. –£—Ä–æ–≤–µ–Ω—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (ADR)

- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (Architecture Decision Records) —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `docs/architecture/decisions/`.
- –§–æ—Ä–º–∞—Ç –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤: `XXXX-–Ω–∞–∑–≤–∞–Ω–∏–µ-—Ä–µ—à–µ–Ω–∏—è.md` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `0001-record-architecture-decisions.md`).
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç ¬´–ø–æ—á–µ–º—É –º—ã –ø—Ä–∏–Ω—è–ª–∏ —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ¬ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–±–æ—Ä Prisma, grammY, PostgreSQL) –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞.

### 12.2. –£—Ä–æ–≤–µ–Ω—å API (Swagger / OpenAPI)

- –î–ª—è REST API (–≠—Ç–∞–ø 6.1) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `@fastify/swagger` –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- –í–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ö–µ–º—ã (Zod) –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.

### 12.3. –ü–æ—Ä—Ç–∞–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

- –í—Å—è –æ–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –º–∞–Ω—É–∞–ª—ã, ADR) —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ `docs/`.
- –ì–ª–∞–≤–Ω—ã–π `README.md` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å–ª—É–∂–∏—Ç –æ—Ç–ø—Ä–∞–≤–Ω–æ–π —Ç–æ—á–∫–æ–π —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.

### 12.4. –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI (Memory Bank)

- –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Å—Ç–∞–π–ª–≥–∞–π–¥—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ `.AI_RULES.md` (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ AI), –∫–æ—Ç–æ—Ä—ã–µ –∞–≥–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ.
