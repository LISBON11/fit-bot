# Бизнес-требования: Telegram-бот тренировок (FitBot)

## 1. Цель продукта (Product Vision)

Бот предназначен для максимального упрощения и ускорения записи результатов тренировок. Главная ценность — возможность надиктовать голосом или написать свободным текстом проделанную тренировку (например, "сделала присед 4 по 12 на 40 кг"), чтобы бот автоматически распознал структуру (упражнения, подходы, веса, комментарии, локацию) и сохранил её в отформатированном виде.

## 2. Пользователи и роли

- **Telegram-пользователь (MVP):** Взаимодействует с системой только через бота. Авторизация происходит прозрачно (по `telegram_id`).
- **Пользователь приложения (v2):** Использует мобильное приложение или веб-интерфейс, авторизуется через связку email/pass или OAuth. Имеет возможность связать свой Telegram-аккаунт с профилем в приложении для сквозного доступа к данным.

## 3. Глоссарий (Словарь терминов)

- **Каноническое упражнение:** Базовое, уникальное название упражнения в системе (например, `back_squat`).
- **Синоним упражнения:** Любое другое название, используемое для канонического упражнения. Может быть глобальным ("присед со штангой") или персональным ("мой присед").
- **Черновик (Draft):** Несохраненная окончательно тренировка. Пользователь может редактировать её до тех пор, пока не подтвердит (Approve) или не отменит (Cancel).
- **Разрешение неоднозначностей (Disambiguation):** Механика уточнения, когда бот предлагает выбрать одно из нескольких упражнений, если пользовательское описание подошло сразу под несколько вариантов.
- **Комментарий (к выполнению):** Дополнительная информация об упражнении (ощущения, боль, техника, асимметрия), которую система извлекает из естественной речи.

## 4. Ключевые сценарии использования (Use Cases)

### Сценарий 1: Ввод новой тренировки (Happy Path)

1. Пользователь отправляет боту голосовое или текстовое сообщение с описанием тренировки.
2. Бот отвечает: `⏳ "Обрабатываю..."`.
3. Система извлекает данные: дату, фокус (например, ноги), место, список упражнений, количество подходов, повторений, веса и комментарии.
4. Если есть неопределенности в распознавании упражнений, запускается **Сценарий 2 (Disambiguation)**.
5. Бот предлагает черновик — красивое превью тренировки с кнопками: `[✅ Approve]`, `[✏️ Edit]`, `[❌ Cancel]`.
   - **Approve:** Тренировка сохраняется, публикуется красивый пост (если настроено), бот удаляет исходное сообщение, отвечает `✅ "Тренировка опубликована!"`.
   - **Edit:** Переход к редактированию текущего черновика (Пользователь присылает дельту правок, например "замени вес в приседе на 45 кг").
   - **Cancel:** Черновик удаляется, бот удаляет исходное голосовое, отвечает `"Тренировка отменена"`.

### Сценарий 2: Разрешение неоднозначностей (Disambiguation)

1. Если при вводе тренировки бот не уверен, какое именно упражнение имел в виду пользователь (например, на слово "присед" найдено несколько канонических упражнений), бот приостанавливает формирование черновика.
2. Бот отправляет сообщение с кнопками выбора: "Что именно?" (например, 1. Back Squat, 2. Front Squat, 3. Goblet Squat, 4. Добавить новое).
3. Пользователь выбирает подходящий вариант.
4. Этот выбор сохраняется как личный маппинг пользователя на будущее. Бот продолжает сценарий ввода тренировки.

### Сценарий 3: Редактирование тренировки по дате

1. Пользователь пишет или говорит боту: "Отредактируй тренировку за 19 февраля" (или использует команду `/edit <дата>`).
2. Бот находит тренировку за эту дату и показывает превью + вопрос "Что изменить?".
3. Пользователь отправляет текст или голосовое с правками (добавить/удалить/изменить упражнения или веса).
4. Бот извлекает _дельту_ изменений, применяет их к тренировке и снова показывает обновлённое превью с кнопками `[✅ Approve]` и `[❌ Cancel]`.

### Сценарий 4: Привязка аккаунта мобильного приложения к Telegram (Link Account)

_Для этапа v2 (мобильное приложение)._

1. Пользователь имеет профиль в приложении, но хочет управлять тренировками через текущего Telegram-бота.
2. В приложении пользователь нажимает "Связать с Telegram". Приложение генерирует одноразовый код (например, `ABC-123`).
3. Пользователь пишет боту: `/link ABC-123`.
4. Бот проверяет код, находит аккаунт приложения и объединяет два аккаунта (Telegram ID и email/OAuth ID связываются с одним бизнес-профилем `user_id`).

## 5. Бизнес-правила (Business Rules)

- **Отсутствие ручной регистрации в боте:** Создание бизнес-профиля происходит бесшовно (auto-register) при первом сообщении от пользователя в Telegram.
- **Один активный черновик:** У пользователя может быть только один активный черновик тренировки.
- **Приватность голоса:** Голосовые сообщения обрабатываются исключительно в оперативной памяти (Buffer), нигде не сохраняются на диск и не логируются.
- **Удаление следов:** После того как тренировка утверждена или отменена, исходное голосовое сообщение удаляется из чата Telegram для сохранения чистоты истории.
- **Фокус на скорости:** STT (Speech-to-Text) и NLU (Natural Language Understanding) должны возвращать результат с минимальной задержкой. В интерфейсе должна присутствовать индикация "набирает сообщение..." при долгой обработке.

## 6. План развития функционала (Roadmap)

| Этап     | Бизнес-фокус                                                                                                | Ожидаемые результаты                                                      |
| -------- | ----------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| **MVP**  | Telegram-бот, core-flow сохранения (голос → draft → approve → публикация).                                  | Готов к использованию бот 1 пользователем.                                |
| **MVP+** | Редактирование прошлых тренировок, персональные синонимы, механика уточнений (disambiguation).              | Гибкое управление историей, бот "учится" понимать язык пользователя.      |
| **v2**   | REST API для мобильного приложения, JWT-авторизация, связывание аккаунтов.                                  | Подготовка архитектуры к Web/Mobile UI, поддержка десятков пользователей. |
| **v3**   | Аналитика (прогресс, объемы, асимметрия мышц), свой сервис транскрибации (опционально), масштабирование БД. | Дашборды, графики прогресса, отчеты по тренировочным блокам.              |

## 7. История бизнес-решений (BDR)

Каждое значимое изменение в продуктовых правилах или ключевых сценариях общения с пользователем фиксируется как отдельный документ в `docs/business/decisions`. Это гарантирует, что мы всегда понимаем, _почему_ продукт работает так, а не иначе.

- Смотреть принятые решения: [Business Decision Records](./decisions/)
