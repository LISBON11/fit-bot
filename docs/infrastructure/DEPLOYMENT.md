# –î–µ–ø–ª–æ–π FitBot: Supabase + –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ + GitHub Actions

> [!WARNING]
> **–í–∞–∂–Ω–æ:** –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ IP-–¥–∏–∞–ø–∞–∑–æ–Ω—ã. –í —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö Telegram
> –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö IP. –ï—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –∞–ø–¥–µ–π—Ç—ã ‚Äî
> –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏ webhook —á–µ—Ä–µ–∑ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —Å–º–µ–Ω–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

```
GitHub (push ‚Üí main)
  ‚îú‚îÄ[CI]‚îÄ‚îÄ‚ñ∫ lint + test + build
  ‚îú‚îÄ[CI]‚îÄ‚îÄ‚ñ∫ docker build ‚Üí ghcr.io/lisbon11/fit-tel-bot:latest
  ‚îî‚îÄ[CD]‚îÄ‚îÄ‚ñ∫ SSH ‚Üí –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ VM ‚Üí docker compose pull + up

–Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ VM:
  ü§ñ bot  ‚îÄ‚îÄ‚ñ∫ Supabase PostgreSQL (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, 500 MB)
  ‚ö° redis ‚îÄ‚îÄ‚ñ∫ Docker –Ω–∞ VM
```

---

## –®–∞–≥ 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase ‚úÖ

–ë–∞–∑–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞:

- –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (`prisma migrate deploy`)
- Seed –∑–∞–ª–∏—Ç (`prisma db seed`) ‚Äî 24 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, 77 —Å–∏–Ω–æ–Ω–∏–º–æ–≤

`DATABASE_URL` ‚Äî Transaction Pooler (–ø–æ—Ä—Ç 6543)  
`DIRECT_URL` ‚Äî Session Pooler (–ø–æ—Ä—Ç 5432)

---

## –®–∞–≥ 2. –°–æ–∑–¥–∞—Ç—å VM –≤ –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ

1. –ó–∞–π–¥–∏ –Ω–∞ [console.yandex.cloud](https://console.yandex.cloud) ‚Üí –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å ID
2. –°–æ–∑–¥–∞–π –ø–ª–∞—Ç—ë–∂–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (–∫–∞—Ä—Ç–∞, –¥–∞—é—Ç ~3000‚ÇΩ –Ω–∞ —Å—Ç–∞—Ä—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
3. –ü–µ—Ä–µ–π–¥–∏ –≤ **Compute Cloud ‚Üí –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã ‚Üí –°–æ–∑–¥–∞—Ç—å –í–ú**
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞:
   - –ó–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: **ru-central1-a** (–ú–æ—Å–∫–≤–∞)
   - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: **Ubuntu 22.04 LTS** (24.04 –≤ –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
   - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: **Intel Ice Lake**, –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–ª—è vCPU: **20%**, RAM: **2 GB** (—Ö–≤–∞—Ç–∏—Ç –¥–ª—è MVP)
   - –ü—É–±–ª–∏—á–Ω—ã–π IP: **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** (–≤—ã–¥–µ–ª–∏—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π)
   - SSH-–∫–ª—é—á–∏: –≤—Å—Ç–∞–≤—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:
     ```bash
     cat ~/.ssh/id_ed25519.pub
     ```
5. –ù–∞–∂–º–∏ **–°–æ–∑–¥–∞—Ç—å –í–ú** ‚Üí –¥–æ–∂–¥–∏—Å—å —Å—Ç–∞—Ç—É—Å–∞ **Running**
6. –ó–∞–ø–æ–º–Ω–∏ –ø—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å VM

---

## –®–∞–≥ 3. –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ VM

–ü–æ–¥–∫–ª—é—á–∏—Å—å –ø–æ SSH:

```bash
ssh yc-user@<IP-–∞–¥—Ä–µ—Å-VM>
```

> [!NOTE]
> –í –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `yc-user`, –Ω–µ `root`.

–£—Å—Ç–∞–Ω–æ–≤–∏ Docker:

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
curl -fsSL https://get.docker.com | sudo sh

# –î–æ–±–∞–≤—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker (–±–µ–∑ sudo)
sudo usermod -aG docker yc-user

# –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Å—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤
exit
ssh yc-user@<IP>

# –ü—Ä–æ–≤–µ—Ä–∫–∞
docker --version
docker compose version
```

–°–∫–ª–æ–Ω–∏—Ä—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

```bash
git clone https://github.com/lisbon11/fit-tel-bot.git
cd fit-tel-bot
```

–°–æ–∑–¥–∞–π `.env`:

```bash
cp .env.example .env
nano .env
```

–ó–∞–ø–æ–ª–Ω–∏ `.env`:

```env
NODE_ENV=production
BOT_TOKEN=<—Ç–æ–∫–µ–Ω –æ—Ç @BotFather>
DEEPGRAM_API_KEY=<–∫–ª—é—á –æ—Ç Deepgram>
DEEPSEEK_API_KEY=<–∫–ª—é—á –æ—Ç DeepSeek>
DATABASE_URL=<Supabase Transaction Pooler URL, –ø–æ—Ä—Ç 6543>
DIRECT_URL=<Supabase Session Pooler URL, –ø–æ—Ä—Ç 5432>
REDIS_PASSWORD=<–Ω–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å>
REDIS_URL=redis://:–Ω–∞–¥—ë–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å@redis:6379
LOG_LEVEL=info
PUBLISH_CHAT_ID=<ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π>
```

---

## –®–∞–≥ 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitHub Secrets

GitHub ‚Üí —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Üí **Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret**

| –ò–º—è              | –ó–Ω–∞—á–µ–Ω–∏–µ                                |
| ---------------- | --------------------------------------- |
| `SERVER_HOST`    | IP –∞–¥—Ä–µ—Å –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ VM               |
| `SERVER_USER`    | `yc-user`                               |
| `SERVER_SSH_KEY` | –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á: `cat ~/.ssh/id_ed25519` |

> [!CAUTION]
> `SERVER_SSH_KEY` ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ** –∫–ª—é—á–∞ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `-----BEGIN OPENSSH PRIVATE KEY-----`).

---

## –®–∞–≥ 5. –†–∞–∑—Ä–µ—à–∏—Ç—å GitHub Actions –ø—É—à–∏—Ç—å –æ–±—Ä–∞–∑—ã

GitHub ‚Üí **Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions ‚Üí Read and write permissions** ‚Üí Save

---

## –®–∞–≥ 6. –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π

```bash
git push origin main
```

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. ‚úÖ Lint + tests + build
2. üê≥ Docker build ‚Üí push `ghcr.io/lisbon11/fit-tel-bot:latest`
3. üöÄ SSH –Ω–∞ VM ‚Üí `./deploy.sh`

–ù–∞ VM `deploy.sh` –≤—ã–ø–æ–ª–Ω–∏—Ç:

```bash
git pull origin main
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
npx prisma migrate deploy   # –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ)
docker image prune -f
```

---

## –®–∞–≥ 7. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ù–∞ VM ‚Äî –ª–æ–≥–∏ –±–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker compose -f docker-compose.prod.yml logs -f bot
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```json
{ "level": "info", "msg": "Bot started" }
```

**–¢–µ—Å—Ç –≤ Telegram:** –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É `/start` ‚Üí –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º.

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º

–õ—é–±–æ–π `git push origin main` ‚Üí –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π. –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:

```bash
ssh yc-user@<IP>
cd ~/fit-tel-bot
./deploy.sh
```

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

| –ü—Ä–æ–±–ª–µ–º–∞            | –†–µ—à–µ–Ω–∏–µ                                                       |
| ------------------- | ------------------------------------------------------------- |
| –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç     | `docker compose logs bot` ‚Äî —Å–º–æ—Ç—Ä–∏ –æ—à–∏–±–∫–∏                     |
| –û—à–∏–±–∫–∞ –ë–î           | –ü—Ä–æ–≤–µ—Ä—å `DATABASE_URL` –≤ `.env` –Ω–∞ VM, –ø–æ—Ä—Ç 6543              |
| Telegram –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç | –í–æ–∑–º–æ–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ø–Ω–¥–µ–∫—Å IP ‚Äî –ø–æ–ø—Ä–æ–±—É–π webhook —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ |
| CI –Ω–µ –ø—É—à–∏—Ç –æ–±—Ä–∞–∑   | GitHub ‚Üí Settings ‚Üí Actions ‚Üí Read and write permissions      |
| Deploy –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç  | –ü—Ä–æ–≤–µ—Ä—å Secrets: `SERVER_USER=yc-user` (–Ω–µ root!)             |
