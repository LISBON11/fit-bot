# –î–µ–ø–ª–æ–π FitBot: Supabase + –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ + GitHub Actions

> [!WARNING]
> **–í–∞–∂–Ω–æ:** –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ IP-–¥–∏–∞–ø–∞–∑–æ–Ω—ã. –í —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö Telegram
> –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö IP. –ï—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –∞–ø–¥–µ–π—Ç—ã ‚Äî
> –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏ webhook —á–µ—Ä–µ–∑ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —Å–º–µ–Ω–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

```
GitHub (push ‚Üí main)
  ‚îú‚îÄ[CI]‚îÄ‚îÄ‚ñ∫ lint + test + build
  ‚îú‚îÄ[CI]‚îÄ‚îÄ‚ñ∫ docker build ‚Üí ghcr.io/lisbon11/fit-bot:latest
  ‚îî‚îÄ[CD]‚îÄ‚îÄ‚ñ∫ SSH ‚Üí –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ VM ‚Üí docker compose pull + up

–Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ VM:
  ü§ñ bot  ‚îÄ‚îÄ‚ñ∫ Supabase PostgreSQL (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, 500 MB)
  ‚ö° redis ‚îÄ‚îÄ‚ñ∫ Docker –Ω–∞ VM
```

---

## –®–∞–≥ 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase ‚úÖ

–ë–∞–∑–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞:

- –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (`prisma migrate deploy`)
- Seed –∑–∞–ª–∏—Ç (`prisma db seed`) ‚Äî 24 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, 77 —Å–∏–Ω–æ–Ω–∏–º–æ–≤

`DATABASE_URL` ‚Äî Transaction Pooler (–ø–æ—Ä—Ç 6543)  
`DIRECT_URL` ‚Äî Session Pooler (–ø–æ—Ä—Ç 5432)

---

## –®–∞–≥ 2. –°–æ–∑–¥–∞—Ç—å VM –≤ –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ

1. –ó–∞–π–¥–∏ –Ω–∞ [console.yandex.cloud](https://console.yandex.cloud) ‚Üí –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å ID
2. –°–æ–∑–¥–∞–π –ø–ª–∞—Ç—ë–∂–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (–∫–∞—Ä—Ç–∞, –¥–∞—é—Ç ~3000‚ÇΩ –Ω–∞ —Å—Ç–∞—Ä—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
3. –ü–µ—Ä–µ–π–¥–∏ –≤ **Compute Cloud ‚Üí –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã ‚Üí –°–æ–∑–¥–∞—Ç—å –í–ú**
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞:
   - –ó–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: **ru-central1-a** (–ú–æ—Å–∫–≤–∞)
   - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: **Ubuntu 22.04 LTS** (24.04 –≤ –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
   - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: **Intel Ice Lake**, –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–ª—è vCPU: **20%**, RAM: **2 GB** (—Ö–≤–∞—Ç–∏—Ç –¥–ª—è MVP)
   - –ü—É–±–ª–∏—á–Ω—ã–π IP: **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∑–∂–µ)
   - SSH-–∫–ª—é—á–∏: –≤—Å—Ç–∞–≤—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞:
     ```bash
     cat ~/.ssh/id_ed25519.pub
     ```
     –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `ubuntu` –∏ –¥–æ–±–∞–≤–∏—Ç –∫–ª—é—á –≤ `authorized_keys`.
5. –ù–∞–∂–º–∏ **–°–æ–∑–¥–∞—Ç—å –í–ú** ‚Üí –¥–æ–∂–¥–∏—Å—å —Å—Ç–∞—Ç—É—Å–∞ **Running**
6. –ó–∞–ø–æ–º–Ω–∏ –ø—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å VM

> [!NOTE]
> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—Ä–∞–∑–æ–≤ Ubuntu –≤ –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ ‚Äî **`ubuntu`** (–Ω–µ `yc-user`). –ö–ª—é—á **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ VM ‚Äî –ø–æ—Å–ª–µ cloud-init —É–∂–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## –®–∞–≥ 3. –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ VM

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH

```bash
ssh -l ubuntu <IP-–∞–¥—Ä–µ—Å-VM>
# –∏–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ:
ssh ubuntu@<IP-–∞–¥—Ä–µ—Å-VM>
```

> [!NOTE]
>
> - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: **`ubuntu`** (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ Ubuntu –≤ –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–µ)
> - IP –∞–¥—Ä–µ—Å VM –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π ‚Äî –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ. –ê–∫—Ç—É–∞–ª—å–Ω—ã–π IP —Å–º–æ—Ç—Ä–∏ –≤ [console.yandex.cloud](https://console.yandex.cloud) ‚Üí Compute Cloud ‚Üí –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã ‚Üí –∫–æ–ª–æ–Ω–∫–∞ **–ü—É–±–ª–∏—á–Ω—ã–π IPv4**

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –¥—Ä—É–≥–æ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É ‚Äî –¥–æ–±–∞–≤—å –µ–≥–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ VM:

```bash
# –ù–∞ VM: –¥–æ–±–∞–≤—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
echo "<–ø—É–±–ª–∏—á–Ω—ã–π-–∫–ª—é—á-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞>" >> ~/.ssh/authorized_keys
```

–õ–∏–±–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–∏–π–Ω—É—é –∫–æ–Ω—Å–æ–ª—å –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–∞ (VM ‚Üí **–°–µ—Ä–∏–π–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å** ‚Üí **–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è**) ‚Äî –µ—Å–ª–∏ SSH –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.

–£—Å—Ç–∞–Ω–æ–≤–∏ Docker:

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
curl -fsSL https://get.docker.com | sudo sh

# –î–æ–±–∞–≤—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker (–±–µ–∑ sudo)
sudo usermod -aG docker ubuntu

# –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Å—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤
exit
ssh ubuntu@<IP>

# –ü—Ä–æ–≤–µ—Ä–∫–∞
docker --version
docker compose version
```

> [!NOTE]
> –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ VM **–Ω–µ –Ω—É–∂–Ω–æ** ‚Äî CI/CD –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É–µ—Ç `docker-compose.prod.yml`, `deploy.sh` –∏ —Å–æ–∑–¥–∞—ë—Ç `.env` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ.

---

## –®–∞–≥ 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GitHub Secrets –∏ Variables

GitHub ‚Üí —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Üí **Settings ‚Üí Secrets and variables ‚Üí Actions**

### Secrets ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

**New repository secret** ‚Äî –º–∞—Å–∫–∏—Ä—É—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö –ø–∞–π–ø–ª–∞–π–Ω–∞, –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ `${{ secrets.NAME }}`

| –ò–º—è                | –ó–Ω–∞—á–µ–Ω–∏–µ                                    |
| ------------------ | ------------------------------------------- |
| `SERVER_HOST`      | IP –∞–¥—Ä–µ—Å –Ø–Ω–¥–µ–∫—Å –û–±–ª–∞–∫–æ VM                   |
| `SERVER_SSH_KEY`   | –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á: `cat ~/.ssh/id_ed25519`     |
| `BOT_TOKEN`        | –¢–æ–∫–µ–Ω –æ—Ç @BotFather                         |
| `DEEPGRAM_API_KEY` | API-–∫–ª—é—á Deepgram                           |
| `DEEPSEEK_API_KEY` | API-–∫–ª—é—á DeepSeek                           |
| `DATABASE_URL`     | Supabase Transaction Pooler URL (–ø–æ—Ä—Ç 6543) |
| `DIRECT_URL`       | Supabase Session Pooler URL (–ø–æ—Ä—Ç 5432)     |
| `REDIS_PASSWORD`   | –ü–∞—Ä–æ–ª—å Redis (–ø—Ä–∏–¥—É–º–∞–π –Ω–∞–¥—ë–∂–Ω—ã–π)            |
| `REDIS_URL`        | `redis://:–Ω–∞–¥—ë–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å@redis:6379`       |
| `PUBLISH_CHAT_ID`  | ID Telegram-–∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π           |

> [!CAUTION]
> `SERVER_SSH_KEY` ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ** –∫–ª—é—á–∞ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `-----BEGIN OPENSSH PRIVATE KEY-----`).

### Variables ‚Äî –Ω–µ—Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

**New repository variable** ‚Äî –≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö, –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ `${{ vars.NAME }}`

| –ò–º—è           | –ó–Ω–∞—á–µ–Ω–∏–µ |
| ------------- | -------- |
| `SERVER_USER` | `ubuntu` |
| `LOG_LEVEL`   | `info`   |

---

## –®–∞–≥ 5. –†–∞–∑—Ä–µ—à–∏—Ç—å GitHub Actions –ø—É—à–∏—Ç—å –æ–±—Ä–∞–∑—ã

GitHub ‚Üí **Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions ‚Üí Read and write permissions** ‚Üí Save

---

## –®–∞–≥ 6. –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π

```bash
git push origin main
```

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. ‚úÖ Lint + tests + build
2. üê≥ Docker build ‚Üí push `ghcr.io/lisbon11/fit-bot:latest`
3. üöÄ SSH –Ω–∞ VM ‚Üí `./deploy.sh`

–ù–∞ VM `deploy.sh` –≤—ã–ø–æ–ª–Ω–∏—Ç:

```bash
git pull origin main
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
npx prisma migrate deploy   # –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ)
docker image prune -f
```

---

## –®–∞–≥ 7. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ù–∞ VM ‚Äî –ª–æ–≥–∏ –±–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker compose -f docker-compose.prod.yml logs -f bot
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```json
{ "level": "info", "msg": "Bot started" }
```

**–¢–µ—Å—Ç –≤ Telegram:** –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É `/start` ‚Üí –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º.

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º

–õ—é–±–æ–π `git push origin main` ‚Üí –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π. –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:

```bash
ssh yc-user@<IP>
cd ~/fit-bot
./deploy.sh
```

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

| –ü—Ä–æ–±–ª–µ–º–∞            | –†–µ—à–µ–Ω–∏–µ                                                       |
| ------------------- | ------------------------------------------------------------- |
| –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç     | `docker compose logs bot` ‚Äî —Å–º–æ—Ç—Ä–∏ –æ—à–∏–±–∫–∏                     |
| –û—à–∏–±–∫–∞ –ë–î           | –ü—Ä–æ–≤–µ—Ä—å `DATABASE_URL` –≤ `.env` –Ω–∞ VM, –ø–æ—Ä—Ç 6543              |
| Telegram –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç | –í–æ–∑–º–æ–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ø–Ω–¥–µ–∫—Å IP ‚Äî –ø–æ–ø—Ä–æ–±—É–π webhook —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ |
| CI –Ω–µ –ø—É—à–∏—Ç –æ–±—Ä–∞–∑   | GitHub ‚Üí Settings ‚Üí Actions ‚Üí Read and write permissions      |
| Deploy –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç  | –ü—Ä–æ–≤–µ—Ä—å Secrets: `SERVER_USER=yc-user` (–Ω–µ root!)             |
