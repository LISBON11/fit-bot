import type { Conversation } from '@grammyjs/conversations';
import type { CustomContext } from '../types.js';
import {
  getSttService,
  getNluParser,
  exerciseService,
  workoutService,
} from '../../services/index.js';
import { createLogger } from '../../logger/logger.js';
import { AppError } from '../../errors/app-errors.js';
import { createExercisePickerKeyboard } from '../keyboards/exercisePicker.js';
import { createWorkoutPreviewKeyboard } from '../keyboards/workoutPreview.js';
import { formatPreview } from '../formatters/workoutFormatter.js';
import type { WorkoutWithRelations } from '../formatters/workoutFormatter.js';
import { PublisherService } from '../../services/publisher.service.js';
import type { Exercise } from '@prisma/client';
import { downloadAndTranscribeVoice } from '../utils/telegram.js';
import { runDisambiguationLoop } from '../utils/disambiguation.js';

const convLogger = createLogger('newWorkoutConversation');

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π FSM-–≥—Ä–∞—Ñ(conversation) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç/–≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–∞—Ä—Å–∏–Ω–≥, —É—Ç–æ—á–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—é.
 */
export async function newWorkout(
  conversation: Conversation<CustomContext, CustomContext>,
  ctx: CustomContext,
): Promise<void> {
  convLogger.info({ userId: ctx.user?.id }, 'Started newWorkout conversation');

  if (!ctx.user) {
    throw new AppError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 401);
  }

  const userId = ctx.user.id;

  let rawText = '';

  // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (–≥–æ–ª–æ—Å -> STT –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —Ç–µ–∫—Å—Ç)
  if (ctx.message?.voice) {
    rawText = await downloadAndTranscribeVoice(ctx, conversation);
  } else if (ctx.message?.text) {
    rawText = ctx.message.text;
  } else {
    await ctx.reply('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
    return;
  }

  if (!rawText.trim()) {
    await ctx.reply('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    return;
  }

  // 2. NLU Parsing
  await ctx.replyWithChatAction('typing');
  const nluParser = getNluParser();
  const today = new Date().toISOString().split('T')[0];
  const parsedWorkout = await conversation.external(() => nluParser.parse(rawText, today));

  // 3. –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–µ–π (Disambiguation)
  const draftResult = await runDisambiguationLoop(
    conversation,
    ctx,
    parsedWorkout,
    'draft', // will be generated by createDraft
    false,
  );

  // 4. –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é
  const workoutId = draftResult.workout?.id;
  if (!workoutId) {
    throw new AppError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', 500);
  }
  const fullWorkout = await conversation.external(() => workoutService.getDraftForUser(userId));

  if (!fullWorkout) {
    throw new AppError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫', 500);
  }

  // 4. –ü–æ–∫–∞–∑ –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é –∏ –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
  while (true) {
    const fullWorkout = await conversation.external(() => workoutService.getDraftForUser(userId));

    if (!fullWorkout) {
      throw new AppError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', 404);
    }

    const previewHtml = formatPreview(fullWorkout as WorkoutWithRelations);
    const previewKb = createWorkoutPreviewKeyboard(workoutId);

    const previewMsg = await ctx.reply(previewHtml, {
      parse_mode: 'HTML',
      reply_markup: previewKb,
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    await conversation.external(() =>
      workoutService.updateMessageIds(workoutId, {
        sourceMessageId: ctx.message?.message_id,
        previewMessageId: previewMsg.message_id,
      }),
    );

    // 5. –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (Approve, Edit, Cancel)
    const actionCtx = await conversation.waitForCallbackQuery([/^appr:/, /^edit:/, /^canc:/], {
      otherwise: (otherCtx) =>
        otherCtx.reply(
          '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –ø–æ –∫–Ω–æ–ø–∫–∞–º üëÜ',
          { reply_to_message_id: otherCtx.message?.message_id },
        ),
    });

    const actionData = actionCtx.callbackQuery.data;
    const action = actionData.split(':')[0];

    await actionCtx.answerCallbackQuery();

    if (action === 'appr') {
      // –£—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∏ –ø—É–±–ª–∏–∫—É–µ–º
      await conversation.external(() => workoutService.approveDraft(workoutId));
      const publisher = new PublisherService(ctx.api);
      await conversation.external(() => publisher.publish(previewHtml));

      if (ctx.message?.message_id && ctx.chat?.id) {
        await ctx.api.deleteMessage(ctx.chat.id, ctx.message.message_id).catch(() => {});
      }
      await actionCtx.deleteMessage().catch(() => {});

      await ctx.reply('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
      return;
    } else if (action === 'canc') {
      // –û—Ç–º–µ–Ω—è–µ–º
      await conversation.external(() => workoutService.cancelDraft(workoutId));
      if (ctx.message?.message_id && ctx.chat?.id) {
        await ctx.api.deleteMessage(ctx.chat.id, ctx.message.message_id).catch(() => {});
      }
      await actionCtx.deleteMessage().catch(() => {});

      await ctx.reply('‚ùå –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
      return;
    } else if (action === 'edit') {
      // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–µ–ª—å—Ç—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
      await ctx.reply('‚úèÔ∏è –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å? (–Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ)');

      const editInputCtx = await conversation.waitFor(['message:text', 'message:voice']);
      let editRawText = '';

      if (editInputCtx.message?.voice) {
        await ctx.replyWithChatAction('typing');
        const file = await conversation.external(() => editInputCtx.getFile());
        const { getConfig } = await conversation.external(() => import('../../config/env.js'));
        const response = await conversation.external(() =>
          fetch(`https://api.telegram.org/file/bot${getConfig().BOT_TOKEN}/${file.file_path}`),
        );
        const arrayBuffer = await conversation.external(() => response.arrayBuffer());
        const sttService = getSttService();
        editRawText = await conversation.external(() =>
          sttService.transcribe(Buffer.from(arrayBuffer), 'ru'),
        );
      } else {
        editRawText = editInputCtx.message?.text || '';
      }

      if (!editRawText.trim()) {
        await ctx.reply('‚ö†Ô∏è –ù–µ –ø–æ–Ω—è–ª –≤–∞—Å. –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã.');
        continue;
      }

      await ctx.replyWithChatAction('typing');
      const parsedEditDelta = await conversation.external(() =>
        nluParser.parseEdit(editRawText, today, JSON.stringify(fullWorkout, null, 2)),
      );

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Ä–µ–∑–æ–ª–≤–∏–º –Ω–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      let editResult = await conversation.external(() =>
        workoutService.applyEdits(workoutId, userId, parsedEditDelta),
      );

      while (editResult.status === 'needs_disambiguation') {
        const ambiguousExercises = editResult.ambiguousExercises || [];

        for (const ambig of ambiguousExercises) {
          if (ambig.mappedExerciseId) continue;

          const resolveResult = await conversation.external(() =>
            exerciseService.resolveExercise(ambig.originalName, userId),
          );

          let options: Array<Pick<Exercise, 'id' | 'canonicalName' | 'displayNameRu'>> = [];
          if (resolveResult.status === 'ambiguous') {
            options = resolveResult.options;
          }

          const kb = createExercisePickerKeyboard(options);
          await ctx.reply(
            `–ù–µ–º–Ω–æ–≥–æ –Ω–µ –ø–æ–Ω—è–ª –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: "${ambig.originalName}". –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ:`,
            { reply_markup: kb },
          );

          const responseCtx = await conversation.waitForCallbackQuery([/^map:/, 'new_exercise']);
          const data = responseCtx.callbackQuery.data;
          await responseCtx.answerCallbackQuery();
          await responseCtx.deleteMessage().catch(() => {});

          if (data.startsWith('map:')) {
            const exId = data.split(':')[1];
            await conversation.external(() =>
              exerciseService.confirmMapping(userId, ambig.originalName, exId),
            );
            ambig.mappedExerciseId = exId;
          } else if (data === 'new_exercise') {
            ambig.mappedExerciseId = 'raw';
          }
        }

        editResult = await conversation.external(() =>
          workoutService.applyEdits(workoutId, userId, parsedEditDelta),
        );
      }

      await ctx.reply('üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!');
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–µ–≤—å—é –∏ –∏–¥–µ–º –Ω–∞ –Ω–æ–≤—ã–π –∫—Ä—É–≥ while(true)
      await actionCtx.deleteMessage().catch(() => {});
    }
  }
}
